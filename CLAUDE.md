# Ghostty Terminal Communication Project - CLAUDE.md

## ğŸ¯ é¡¹ç›®ä½¿å‘½
åœ¨Ghosttyä¸­å®ç°ç±»ä¼¼tmuxçš„ç»ˆç«¯é—´é€šä¿¡èƒ½åŠ›ï¼Œå…è®¸ç»ˆç«¯Aå‘ç»ˆç«¯Bå‘é€å‘½ä»¤å¹¶æ¥æ”¶å“åº”ï¼ŒåŒ…æ‹¬SSHè¿œç¨‹åœºæ™¯ã€‚

## ğŸ“– é¡¹ç›®èƒŒæ™¯

### å‰ä¸¤æ¬¡å¤±è´¥çš„æ•™è®­
1. **ç¬¬ä¸€æ¬¡å¤±è´¥**ï¼šè¯•å›¾æå–tmuxä¸ºlibtmuxcoreï¼Œåˆ›å»º175ä¸ªæ–‡ä»¶ï¼Œ9+ä¸ªagentsï¼Œè¿‡åº¦ç»„ç»‡åŒ–
2. **ç¬¬äºŒæ¬¡å¤±è´¥**ï¼šæ„å»º916KBçš„libtmuxcore.dylibï¼Œå¯¼å‡º999ä¸ªç¬¦å·ï¼Œè¿‡åº¦å·¥ç¨‹åŒ–

### ç¬¬ä¸‰æ¬¡æˆåŠŸçš„å…³é”®
1. **æºç éªŒè¯æ¶æ„**ï¼šé€šè¿‡é˜…è¯»å®é™…ä»£ç ç†è§£tmuxå’ŒGhosttyçš„æ¶æ„
2. **æ‰¾å‡†å±‚æ¬¡å¯¹åº”**ï¼štmux server â†” Ghostty Appå±‚çš„å‡†ç¡®æ˜ å°„
3. **æœ€å°åŒ–å®ç°**ï¼šèšç„¦æ ¸å¿ƒéœ€æ±‚ - ç»ˆç«¯é—´å‘é€å‘½ä»¤

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„ç†è§£

### tmuxæ¶æ„ï¼ˆå·²éªŒè¯ï¼‰
```
tmux client â†’ tmux server â†’ session â†’ window â†’ pane â†’ PTY
                  â†‘
            æ ¸å¿ƒè·¯ç”±å±‚
    (bufferevent_writeç›´æ¥å†™å…¥PTY)
```

### Ghosttyæ¶æ„ï¼ˆå·²éªŒè¯ï¼‰
```
IPC â†’ App â†’ Surface â†’ Termio â†’ Terminal â†’ PTY
       â†‘
   å¯¹åº”tmux serverå±‚
   (ç®¡ç†æ‰€æœ‰Surfaceå®ä¾‹)
```

### å…³é”®ä»£ç è·¯å¾„
- **tmux**: `cmd-send-keys.c` â†’ `window_pane_key()` â†’ `input_key_pane()` â†’ `bufferevent_write()`
- **Ghostty**: `App.zig` â†’ `Surface.zig` â†’ `Termio.zig` â†’ `backend.write()`

## ğŸ¯ æœ€å°åŒ–å®ç°æ–¹æ¡ˆ

### Phase 1: æ ¸å¿ƒåŠŸèƒ½ï¼ˆMVPï¼‰
1. åœ¨Appå±‚æ·»åŠ SessionManager
2. æ‰©å±•IPCæ”¯æŒsend_to_session
3. Surfaceæ·»åŠ session_id
4. å®ç°åŸºæœ¬çš„æ¶ˆæ¯è·¯ç”±

### Phase 2: SSHæ”¯æŒ
1. åˆ©ç”¨ç°æœ‰shell integration
2. é€šè¿‡OSC 777å»ºç«‹é€šä¿¡é€šé“
3. ç¯å¢ƒå˜é‡ä¼ é€’sessionä¿¡æ¯

### Phase 3: ç”¨æˆ·ä½“éªŒ
1. å®ç°@send, @linkå‘½ä»¤
2. æ·»åŠ ä¼šè¯ç®¡ç†å‘½ä»¤
3. å¯è§†åŒ–çŠ¶æ€æ˜¾ç¤º

## âš™ï¸ æŠ€æœ¯å®ç°ç»†èŠ‚

### å…³é”®æ–‡ä»¶ä¿®æ”¹
```
src/App.zig                    # æ·»åŠ SessionManager
src/Surface.zig                # æ·»åŠ session_idå­—æ®µ
src/apprt/ipc.zig             # æ‰©å±•Actionæšä¸¾
src/terminal/SessionManager.zig # æ–°å¢æ ¸å¿ƒç®¡ç†å™¨
src/termio/Termio.zig         # æ¶ˆæ¯æ‹¦æˆªç‚¹
```

### é€šä¿¡åè®®
- **æœ¬åœ°**: D-Bus IPC + ç›´æ¥PTYå†™å…¥
- **è¿œç¨‹**: OSC 777åºåˆ— + Shell Integration

### å‘½ä»¤è®¾è®¡
```bash
# å†…éƒ¨å‘½ä»¤ï¼ˆç»ˆç«¯å†…ï¼‰
@send <session-id> <command>
@link <session-id>
@sessions

# å¤–éƒ¨å‘½ä»¤ï¼ˆå‘½ä»¤è¡Œï¼‰
ghostty send <session-id> <command>
ghostty link <session-id>
```

## ğŸ“‹ ä»£ç é›†æˆæ£€æŸ¥æ¸…å•

### å¿…é¡»å®Œæˆ
- [ ] App.zigé›†æˆSessionManager
- [ ] IPC Actionæ‰©å±•
- [ ] Surface session_idå®ç°
- [ ] åŸºæœ¬sendåŠŸèƒ½
- [ ] å•å…ƒæµ‹è¯•

### åº”è¯¥å®Œæˆ
- [ ] Shell integrationé›†æˆ
- [ ] OSC 777åè®®
- [ ] ä¼šè¯æŒä¹…åŒ–
- [ ] é”™è¯¯å¤„ç†

### å¯ä»¥å®Œæˆ
- [ ] GUIç®¡ç†ç•Œé¢
- [ ] é«˜çº§è¿‡æ»¤å™¨
- [ ] æ€§èƒ½ç›‘æ§

## ğŸš« é¿å…çš„é™·é˜±

1. **ä¸è¦**è¯•å›¾æå–tmuxä»£ç 
2. **ä¸è¦**åˆ›å»ºç‹¬ç«‹çš„åº“
3. **ä¸è¦**è¿‡åº¦æŠ½è±¡å’Œè®¾è®¡
4. **ä¸è¦**åç¦»æ ¸å¿ƒéœ€æ±‚
5. **ä¸è¦**å¼•å…¥ä¸å¿…è¦çš„ä¾èµ–

## ğŸ“Š æˆåŠŸæ ‡å‡†

### åŠŸèƒ½æ ‡å‡†
- âœ… ç»ˆç«¯Aèƒ½å‘é€å‘½ä»¤åˆ°ç»ˆç«¯B
- âœ… æ”¯æŒåŒå‘é€šä¿¡
- âœ… SSHè¿œç¨‹åœºæ™¯å¯ç”¨
- âœ… å‘½ä»¤ç®€æ´ç›´è§‚

### æŠ€æœ¯æ ‡å‡†
- âœ… ä»£ç ä¿®æ”¹æœ€å°åŒ–ï¼ˆ<10ä¸ªæ–‡ä»¶ï¼‰
- âœ… ä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… æ€§èƒ½å¼€é”€å¯å¿½ç•¥
- âœ… æ˜“äºæµ‹è¯•å’Œè°ƒè¯•

## ğŸ”§ å¼€å‘åŸåˆ™

1. **KISSåŸåˆ™**ï¼šä¿æŒç®€å•ç›´æ¥
2. **æœ€å°ä¾µå…¥**ï¼šå°½é‡å°‘ä¿®æ”¹ç°æœ‰ä»£ç 
3. **å¢é‡å¼€å‘**ï¼šå…ˆå®ç°æ ¸å¿ƒï¼Œå†æ·»åŠ åŠŸèƒ½
4. **ä»£ç ä¼˜å…ˆ**ï¼šç”¨ä»£ç éªŒè¯æƒ³æ³•
5. **ç”¨æˆ·ä½“éªŒ**ï¼šå‘½ä»¤è¦ç›´è§‚æ˜“ç”¨

## ğŸ“ é¡¹ç›®çŠ¶æ€

### å·²å®Œæˆ
- âœ… æ¶æ„åˆ†æå’ŒéªŒè¯
- âœ… å®ç°æ–¹æ¡ˆè®¾è®¡
- âœ… SessionManageråŸå‹
- âœ… æ¼”ç¤ºè„šæœ¬
- âœ… Phase 1: åŸºç¡€ç»ˆç«¯é—´é€šä¿¡åŠŸèƒ½ï¼ˆ2024-12ï¼‰
- âœ… Phase 2: ä¼šè¯ç®¡ç†å‘½ä»¤æ‰©å±•ï¼ˆ2024-12-28ï¼‰
- âœ… **å…³é”®ä¿®å¤**: @ghostty sendå‘½ä»¤æ‰§è¡Œé—®é¢˜ï¼ˆ2024-12-29ï¼‰

### é‡è¦ä¿®å¤è®°å½•ï¼ˆ2024-12-29ï¼‰

#### @ghostty sendå‘½ä»¤æ‰§è¡Œä¿®å¤
**é—®é¢˜æè¿°**ï¼šé€šè¿‡`@ghostty send`å‘é€çš„å‘½ä»¤åœ¨æ¥æ”¶ç»ˆç«¯ä»…æ˜¾ç¤ºä¸ºæ–‡æœ¬ï¼Œè€Œä¸æ‰§è¡Œå‘½ä»¤ã€‚

**æ ¹æœ¬åŸå› **ï¼š
1. æ¶ˆæ¯ç›´æ¥é€šè¿‡`termio.Message.writeReq`å†™å…¥PTY
2. ç»•è¿‡äº†Surfaceå±‚çš„`@ghostty`å‘½ä»¤æ£€æµ‹æœºåˆ¶
3. é”®ç›˜äº‹ä»¶å¤„ç†é¡ºåºé—®é¢˜ï¼škeybinding handleråœ¨@æ£€æµ‹ä¹‹å‰æ¶ˆè´¹äº†äº‹ä»¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨Surface.zigæ·»åŠ `processReceivedMessage`å…¬å…±æ–¹æ³•
2. æ¨¡æ‹Ÿå®Œæ•´çš„é”®ç›˜è¾“å…¥æµç¨‹ï¼Œæ¯ä¸ªå­—ç¬¦éƒ½é€šè¿‡`keyCallback`å¤„ç†
3. è°ƒæ•´äº‹ä»¶å¤„ç†é¡ºåºï¼Œå°†@æ£€æµ‹ç§»åˆ°keybinding handlerä¹‹å‰ï¼ˆè¡Œ2229ï¼‰
4. SessionManagerä½¿ç”¨æ–°æ–¹æ³•ç¡®ä¿å‘½ä»¤æ­£ç¡®è§¦å‘

**ä»£ç å˜æ›´**ï¼š
- `Surface.zig`: æ·»åŠ processReceivedMessageæ–¹æ³•ï¼Œå®ç°é”®ç›˜è¾“å…¥æ¨¡æ‹Ÿ
- `SessionManager.zig`: ä¿®æ”¹deliverMessageä½¿ç”¨Surfaceçš„æ–°æ–¹æ³•
- ä¿®å¤äº†`self.renderer_state.terminal`åº”ä¸º`self.io.terminal`çš„å¼•ç”¨é—®é¢˜

**å½±å“**ï¼š
- `@ghostty send agent "@ghostty help"`ç°åœ¨ä¼šæ­£ç¡®æ‰§è¡Œhelpå‘½ä»¤
- æ‰€æœ‰é€šè¿‡sendå‘é€çš„@ghosttyå‘½ä»¤éƒ½èƒ½æ­£ç¡®è§¦å‘å’Œæ‰§è¡Œ
- ä¿æŒäº†å‘½ä»¤å¤„ç†çš„ä¸€è‡´æ€§

### è¿›è¡Œä¸­
- ğŸ”„ Phase 3: SessionCoreæ¶æ„å‡çº§
- ğŸ”„ Terminalå†…å®¹æå–åŠŸèƒ½

### å¾…å¼€å§‹
- â³ å†…å®¹åŒæ­¥å®ç°
- â³ attach/detachå‘½ä»¤
- â³ å®Œæ•´æµ‹è¯•å¥—ä»¶

## ğŸ¤– AIåŠ©æ‰‹æŒ‡å¯¼

### å¯¹è¯åŸåˆ™
1. å§‹ç»ˆåŸºäºæºç è®¨è®ºï¼Œä¸è¦æƒ³è±¡
2. ä¼˜å…ˆè€ƒè™‘æœ€å°åŒ–å®ç°
3. æ¯ä¸ªå†³ç­–éƒ½è¦æœ‰ä»£ç æ”¯æ’‘
4. ä¿æŒèšç„¦åœ¨æ ¸å¿ƒéœ€æ±‚

### ä»£ç åŸåˆ™
1. ä¿®æ”¹å‰å…ˆè¯»å–ç°æœ‰ä»£ç 
2. æ¯æ¬¡ä¿®æ”¹æ§åˆ¶åœ¨æœ€å°èŒƒå›´
3. ä¿æŒä»£ç é£æ ¼ä¸€è‡´
4. æ·»åŠ å¿…è¦çš„æ³¨é‡Š

### æµ‹è¯•åŸåˆ™
1. å…ˆå†™æµ‹è¯•ï¼Œåå†™ä»£ç 
2. æµ‹è¯•è¦†ç›–æ ¸å¿ƒè·¯å¾„
3. åŒ…å«é”™è¯¯åœºæ™¯æµ‹è¯•

## ğŸ“š å‚è€ƒèµ„æº

### å…³é”®æ–‡æ¡£
- `docs/tmux-ghostty-æ¶æ„å¯¹æ¯”æ–‡æ¡£.md`
- `docs/ghostty-terminal-communication-design.md`
- `scripts/demo-ghostty-terminal-comm.sh`

### æ ¸å¿ƒä»£ç 
- `src/terminal/SessionManager.zig`
- `src/terminal/demo_terminal_communication.zig`

---

**è®°ä½**ï¼šæˆåŠŸçš„å…³é”®æ˜¯**ç®€å•ã€ç›´æ¥ã€æœ€å°åŒ–**ã€‚ä¸è¦é‡å¤å‰ä¸¤æ¬¡çš„é”™è¯¯ï¼