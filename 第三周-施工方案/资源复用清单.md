# ç¬¬ä¸‰å‘¨æ–½å·¥æ–¹æ¡ˆ - èµ„æºå¤ç”¨æ¸…å•
# Week 3 Construction Plan - Resource Reuse Inventory

**åˆ›å»ºæ—¶é—´**: 2025-08-26 22:30  
**ç‰ˆæœ¬**: 1.0  
**ç›®çš„**: æ˜ç¡®æ‰€æœ‰å¯å¤ç”¨èµ„æºï¼Œç¡®ä¿æ–½å·¥æ•ˆç‡æœ€å¤§åŒ–

---

## ğŸ“š ç¬¬ä¸€å‘¨æˆæœå¤ç”¨ï¼ˆ85%å®Œæˆï¼‰

### å¯å¤ç”¨è®¾è®¡æ–‡æ¡£
| æ–‡æ¡£ | ä½ç½® | å¤ç”¨ä»·å€¼ | ä½¿ç”¨å»ºè®® |
|------|------|---------|----------|
| **UI Backendè®¾è®¡** | `/docs/architecture-view/ui-backend-design.md` | â­â­â­â­â­ | T-301-Rç›´æ¥å‚è€ƒæ¥å£è®¾è®¡ |
| **tty_writeæ‹¦æˆªæ–¹æ¡ˆ** | `/docs/architecture-view/tty-write-interception.md` | â­â­â­â­â­ | T-301-Rå®æ–½çš„æ ¸å¿ƒæŒ‡å¯¼ |
| **ABIç¨³å®šæ€§ç­–ç•¥** | `/docs/architecture-view/abi-stability.md` | â­â­â­â­â­ | T-302-Ræ„å»ºåŠ¨æ€åº“å¿…è¯» |
| **å¸§æ‰¹å¤„ç†è®¾è®¡** | `/docs/architecture-view/frame-batching.md` | â­â­â­â­ | T-303-Rå®ç°å›è°ƒå‚è€ƒ |
| **æ¶æ„æ€»è§ˆ** | `/docs/new-architecture-æ–½å·¥å›¾/README.md` | â­â­â­â­â­ | å…¨å±€è§†è§’ç†è§£ |

### å¯å¤ç”¨ä»£ç æ¢ç´¢
```bash
# ç¬¬ä¸€å‘¨åœ¨cache/week1/çš„æ¢ç´¢æ€§ä»£ç 
cache/week1/
â”œâ”€â”€ CORE-001/        # ttyé’©å­æå–å®éªŒ
â”‚   â”œâ”€â”€ hook_extraction_poc.c    # âœ… å¯å¤ç”¨ï¼šé’©å­æå–é€»è¾‘
â”‚   â””â”€â”€ backend_router_draft.c   # âœ… å¯å¤ç”¨ï¼šè·¯ç”±å™¨æ¡†æ¶
â”œâ”€â”€ CORE-002/        # åº“åŒ–å®éªŒ
â”‚   â””â”€â”€ libtmux_prototype.c      # âœ… å¯å¤ç”¨ï¼šåº“åŒ–æ€è·¯
â””â”€â”€ INTG-001/        # FFIæ—©æœŸå®éªŒ
    â””â”€â”€ ffi_concept.zig          # âœ… å¯å¤ç”¨ï¼šFFIåŸºç¡€ç»“æ„
```

### ç¬¬ä¸€å‘¨å…³é”®å‘ç°
1. **22ä¸ªtty_cmd_*å‡½æ•°éœ€è¦æ‹¦æˆª** - å·²è¯†åˆ«å®Œæ•´åˆ—è¡¨
2. **backendè·¯ç”±æ¨¡å¼å¯è¡Œ** - POCéªŒè¯æˆåŠŸ
3. **æ¡ä»¶ç¼–è¯‘æ˜¯å…³é”®** - ä¿æŒå…¼å®¹æ€§çš„æ ¸å¿ƒç­–ç•¥
4. **æ€§èƒ½å¼€é”€å¯æ¥å—** - <100nsè·¯ç”±å¼€é”€

---

## ğŸ’ ç¬¬äºŒå‘¨æˆæœå¤ç”¨ï¼ˆ100%å®Œæˆï¼‰

### æ ¸å¿ƒä»£ç èµ„äº§ï¼ˆç›´æ¥å¯ç”¨ï¼‰

#### 1. äº‹ä»¶å¾ªç¯vtableï¼ˆT-301-Rå¯ç›´æ¥ä½¿ç”¨ï¼‰
```c
// ä½ç½®ï¼šcache/week2/CORE-001/src/event_loop_backend.h
// å¤§å°ï¼š8KB
// çŠ¶æ€ï¼šâœ… ç”Ÿäº§å°±ç»ª
// æ€§èƒ½ï¼š0.8%å¼€é”€ï¼Œ4M ops/sec

typedef struct event_loop_vtable {
    const char* name;
    void* (*init)(void);
    void (*cleanup)(void*);
    int (*event_add)(void*, event_handle_t*, const struct timeval*);
    int (*event_del)(void*, event_handle_t*);
    int (*event_dispatch)(void*, int flags);
    void (*event_active)(void*, event_handle_t*, int what);
} event_loop_vtable_t;

// å¤ç”¨æ–¹æ³•ï¼š
// 1. å¤åˆ¶åˆ° tmux/ui_backend/event_loop_backend.h
// 2. åœ¨ tty.c ä¸­ #include
// 3. åˆå§‹åŒ–æ—¶æ³¨å†Œvtable
```

#### 2. ç½‘æ ¼æ“ä½œSIMDä¼˜åŒ–ï¼ˆT-302-Ré›†æˆï¼‰
```c
// ä½ç½®ï¼šcache/week2/CORE-002/src/grid_operations_neon.c
// å¤§å°ï¼š45KB
// çŠ¶æ€ï¼šâœ… ARM64ä¼˜åŒ–å®Œæˆ
// æ€§èƒ½ï¼š10xæå‡ï¼ˆä½¿ç”¨NEONæŒ‡ä»¤ï¼‰

void grid_copy_cells_neon(grid_cell_t* dst, const grid_cell_t* src, size_t count);
void grid_clear_cells_neon(grid_cell_t* cells, size_t count);
void grid_compare_cells_neon(const grid_cell_t* a, const grid_cell_t* b, size_t count);

// å¤ç”¨æ–¹æ³•ï¼š
// 1. æ·»åŠ åˆ° tmux/grid_simd.c
// 2. åœ¨ Makefile ä¸­æ·»åŠ  -march=native
// 3. è¿è¡Œæ—¶CPUç‰¹æ€§æ£€æµ‹
```

#### 3. FFIæ¡¥æ¥å±‚ï¼ˆT-303-Rç›´æ¥ç§»æ¤ï¼‰
```zig
// ä½ç½®ï¼šcache/week2/INTG-001/callbacks.zig
// å¤§å°ï¼š31KB
// çŠ¶æ€ï¼šâœ… é›¶æ‹·è´å®ç°
// æ€§èƒ½ï¼š<100nså¼€é”€

pub const Callbacks = struct {
    vtable: c.tmc_ui_vtable_t,
    frame_buffer: FrameBuffer,
    
    pub fn onFrame(
        client: *c.tmc_client_t,
        frame: *const c.tmc_frame_t,
        user_data: ?*anyopaque
    ) callconv(.C) void {
        // å®ç°ç»†èŠ‚...
    }
};

// å¤ç”¨æ–¹æ³•ï¼š
// 1. åˆ›å»º ghostty/src/tmux/callbacks.zig
// 2. å¯¼å…¥ç°æœ‰å®ç°
// 3. è°ƒæ•´å‘½åç©ºé—´
```

#### 4. æµ‹è¯•æ¡†æ¶ï¼ˆT-305-Ræ‰©å±•ä½¿ç”¨ï¼‰
```bash
# ä½ç½®ï¼šcache/week2/TESTS/
# è¦†ç›–ç‡ï¼š91%
# çŠ¶æ€ï¼šâœ… å®Œæ•´æµ‹è¯•å¥—ä»¶

integration_tests/
â”œâ”€â”€ test_event_loop.c      # äº‹ä»¶å¾ªç¯æµ‹è¯•
â”œâ”€â”€ test_grid_ops.c        # ç½‘æ ¼æ“ä½œæµ‹è¯•
â”œâ”€â”€ test_callbacks.c       # å›è°ƒç³»ç»Ÿæµ‹è¯•
â””â”€â”€ test_end_to_end.c      # ç«¯åˆ°ç«¯æµ‹è¯•

# å¤ç”¨æ–¹æ³•ï¼š
# 1. å¤åˆ¶åˆ° tests/week3/
# 2. è°ƒæ•´è·¯å¾„ä¸ºçœŸå®æºç 
# 3. æ·»åŠ æ–°çš„é›†æˆæµ‹è¯•
```

### ç¬¬äºŒå‘¨æ€§èƒ½æ•°æ®ï¼ˆä½œä¸ºåŸºçº¿ï¼‰
```yaml
æ€§èƒ½åŸºçº¿:
  äº‹ä»¶å¾ªç¯å¼€é”€: 0.8%
  ç½‘æ ¼æ“ä½œåå: 380k ops/s
  å†…å­˜ä½¿ç”¨: 8.3MB/session
  å»¶è¿Ÿ: <100ns (P99)
  
æµ‹è¯•é€šè¿‡ç‡:
  å•å…ƒæµ‹è¯•: 100% (47/47)
  é›†æˆæµ‹è¯•: 100% (12/12)
  æ€§èƒ½æµ‹è¯•: 100% (8/8)
  å†…å­˜æµ‹è¯•: 100% (æ— æ³„æ¼)
```

---

## ğŸ”§ æ„å»ºç³»ç»Ÿèµ„äº§

### Makefileæ¨¡æ¿ï¼ˆT-302-Rå‚è€ƒï¼‰
```makefile
# ä½ç½®ï¼šcache/week2/Makefile
# å¯å¤ç”¨éƒ¨åˆ†ï¼š

# åŠ¨æ€åº“æ„å»ºè§„åˆ™
%.so: %.o
    $(CC) -shared -fPIC -o $@ $^ $(LDFLAGS)

# ç‰ˆæœ¬è„šæœ¬ä½¿ç”¨
LDFLAGS += -Wl,--version-script=libtmuxcore.sym

# ARM64ä¼˜åŒ–flags
CFLAGS += -march=armv8-a+simd -mtune=apple-m1

# æµ‹è¯•è¦†ç›–ç‡
coverage:
    $(CC) $(CFLAGS) --coverage -o test_suite tests/*.c
    ./test_suite
    gcov *.c
```

### CMakeé…ç½®ï¼ˆå¤‡é€‰ï¼‰
```cmake
# ä½ç½®ï¼šcache/week2/CMakeLists.txt
# ç°ä»£åŒ–æ„å»ºé…ç½®

add_library(tmuxcore SHARED
    ${CORE_SOURCES}
    ${BACKEND_SOURCES}
)

target_compile_features(tmuxcore PRIVATE c_std_11)
target_compile_options(tmuxcore PRIVATE -fPIC)
```

---

## ğŸ“Š æ–‡æ¡£èµ„äº§å¤ç”¨

### æŠ€æœ¯è§„èŒƒæ–‡æ¡£
| æ–‡æ¡£ | ä½ç½® | Week 3ç”¨é€” |
|------|------|-----------|
| **é¡¹ç›®æ€»è§„èŒƒ** | `/project_spec.md` | éªŒæ”¶æ ‡å‡†å‚è€ƒ |
| **ä»»åŠ¡åˆ†è§£WBS** | `/docs/project-manager-view/wbs.puml` | ä»»åŠ¡ä¾èµ–å…³ç³» |
| **å›¢é˜Ÿåä½œæµç¨‹** | `/docs/ä»»åŠ¡æ¸…å•/ç¬¬ä¸€å‘¨/åä½œè®¡åˆ’.md` | å›¢é˜Ÿé…åˆæ¨¡æ¿ |
| **æµ‹è¯•ç­–ç•¥** | `/docs/ä»»åŠ¡æ¸…å•/ç¬¬äºŒå‘¨/QA-002.md` | æµ‹è¯•æ–¹æ³•è®º |

### PlantUMLå›¾è¡¨ï¼ˆå¯æ›´æ–°ï¼‰
```plantuml
# ä½ç½®ï¼šdocs/project-manager-view/å„ç§.pumlæ–‡ä»¶
# ç”¨é€”ï¼šæ›´æ–°è¿›åº¦ï¼Œå±•ç¤ºç¬¬ä¸‰å‘¨é›†æˆæ¶æ„

- architecture.puml     # æ›´æ–°é›†æˆç‚¹
- gantt.puml           # æ›´æ–°æ—¶é—´çº¿
- sequence.puml        # æ·»åŠ æ–°çš„è°ƒç”¨åºåˆ—
```

---

## ğŸš€ ç¬¬ä¸‰å‘¨å¿«é€Ÿå¯åŠ¨æŒ‡å—

### Phase 1: tmuxæºç ä¿®æ”¹ï¼ˆå¤ç”¨ç¬¬ä¸€ã€äºŒå‘¨æˆæœï¼‰

```bash
# Step 1: å¤åˆ¶æ ¸å¿ƒä»£ç 
cp cache/week2/CORE-001/src/event_loop_backend.h tmux/ui_backend/
cp cache/week2/CORE-002/src/grid_operations_neon.c tmux/
cp cache/week1/CORE-001/backend_router_draft.c tmux/

# Step 2: ä¿®æ”¹tty.cï¼ˆå‚è€ƒç¬¬ä¸€å‘¨è®¾è®¡ï¼‰
# ä½¿ç”¨ /docs/architecture-view/tty-write-interception.md ä½œä¸ºæŒ‡å¯¼
vim tmux/tty.c
# åœ¨1234è¡Œæ·»åŠ è·¯ç”±é€»è¾‘

# Step 3: æ›´æ–°Makefileï¼ˆä½¿ç”¨ç¬¬äºŒå‘¨æ¨¡æ¿ï¼‰
# æ·»åŠ  libtmuxcore.so ç›®æ ‡
```

### Phase 2: Ghosttyé›†æˆï¼ˆå¤ç”¨FFIå®ç°ï¼‰

```bash
# Step 1: åˆ›å»ºtmuxæ¨¡å—
mkdir -p ghostty/src/tmux
cp cache/week2/INTG-001/callbacks.zig ghostty/src/tmux/

# Step 2: è°ƒæ•´FFIç»‘å®š
# ä½¿ç”¨å·²éªŒè¯çš„é›¶æ‹·è´è®¾è®¡
vim ghostty/src/tmux/core.zig

# Step 3: æ›´æ–°build.zig
# é“¾æ¥libtmuxcore.so
```

### Phase 3: æµ‹è¯•éªŒè¯ï¼ˆæ‰©å±•ç¬¬äºŒå‘¨æµ‹è¯•ï¼‰

```bash
# Step 1: è¿ç§»æµ‹è¯•å¥—ä»¶
cp -r cache/week2/TESTS/ tests/week3/

# Step 2: æ›´æ–°æµ‹è¯•è·¯å¾„
# æŒ‡å‘çœŸå®æºç è€Œécache

# Step 3: è¿è¡Œå®Œæ•´æµ‹è¯•
make test-all
```

---

## ğŸ’¡ å…³é”®å¤ç”¨ä»·å€¼ç‚¹

### æŠ€æœ¯å€ºåŠ¡å·²è§£å†³
1. âœ… **äº‹ä»¶å¾ªç¯æŠ½è±¡** - ç¬¬äºŒå‘¨å·²å®ç°å¹¶éªŒè¯
2. âœ… **SIMDä¼˜åŒ–** - ARM NEONå·²å®Œæˆï¼Œæ€§èƒ½10xæå‡
3. âœ… **FFIå®‰å…¨æ€§** - é›¶æ‹·è´è®¾è®¡å·²éªŒè¯
4. âœ… **æµ‹è¯•æ¡†æ¶** - 91%è¦†ç›–ç‡çš„å®Œæ•´å¥—ä»¶

### é£é™©å·²è¯†åˆ«
1. âš ï¸ **ABIå…¼å®¹æ€§** - ä½¿ç”¨size/versionå­—æ®µï¼ˆç¬¬ä¸€å‘¨è®¾è®¡ï¼‰
2. âš ï¸ **æ€§èƒ½é€€åŒ–** - åŸºçº¿å·²å»ºç«‹ï¼ˆ380k ops/sï¼‰
3. âš ï¸ **å†…å­˜æ³„æ¼** - Valgrindé…ç½®å·²å°±ç»ª
4. âš ï¸ **æ„å»ºå¤æ‚åº¦** - Makefileæ¨¡æ¿å·²éªŒè¯

### ç»éªŒæ•™è®­åº”ç”¨
1. ğŸ“ **å°æ­¥å¿«è·‘** - æ¯ä¸ªcommitå¯ç¼–è¯‘ï¼ˆç¬¬äºŒå‘¨ç»éªŒï¼‰
2. ğŸ“ **æ¡ä»¶ç¼–è¯‘** - ä¿ç•™åŸè·¯å¾„ï¼ˆç¬¬ä¸€å‘¨å‘ç°ï¼‰
3. ğŸ“ **æŒç»­æµ‹è¯•** - æ¯æ­¥éƒ½éªŒè¯ï¼ˆç¬¬äºŒå‘¨å®è·µï¼‰
4. ğŸ“ **æ–‡æ¡£åŒæ­¥** - è¾¹åšè¾¹å†™ï¼ˆå…¨ç¨‹åšæŒï¼‰

---

## ğŸ¯ ç¬¬ä¸‰å‘¨æˆåŠŸä¿éšœ

é€šè¿‡å¤ç”¨å‰ä¸¤å‘¨èµ„äº§ï¼Œç¬¬ä¸‰å‘¨å¯ä»¥ï¼š

1. **èŠ‚çœæ—¶é—´**: 60%ä»£ç å¯ç›´æ¥å¤ç”¨
2. **é™ä½é£é™©**: å·²éªŒè¯çš„è®¾è®¡å’Œå®ç°
3. **ä¿è¯è´¨é‡**: ç»§æ‰¿91%æµ‹è¯•è¦†ç›–ç‡
4. **æå‡ä¿¡å¿ƒ**: åŸºäºå®æµ‹æ€§èƒ½æ•°æ®

**æ ¸å¿ƒåŸåˆ™**: ä¸é‡å¤é€ è½®å­ï¼Œä¸“æ³¨äºçœŸå®é›†æˆï¼

---

*æœ¬æ–‡æ¡£å°†æŒç»­æ›´æ–°ï¼Œç¡®ä¿æ‰€æœ‰agentæ¸…æ¥šå¯å¤ç”¨èµ„æº*