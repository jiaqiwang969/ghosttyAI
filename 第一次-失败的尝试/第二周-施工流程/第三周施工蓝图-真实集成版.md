# 第三周施工蓝图 - 真实 Ghostty 源码集成版
# Week 3 Construction Blueprint - Real Ghostty Source Integration

**版本**: 2.0 (Revised)  
**创建时间**: 2025-08-26 22:00  
**状态**: 待架构师评审  

---

## 🚨 关键发现：集成差距分析

### 当前状态（第二周结束）
```
cache/week2/
├── CORE-001/          # ✅ Event loop vtable (prototype)
├── CORE-002/          # ✅ Grid operations (prototype) 
├── INTG-001/          # ✅ FFI bridge (prototype)
├── INTG-002/          # ✅ Callback system (prototype)
└── TESTS/             # ✅ 91% coverage (on prototypes)

Status: 完成原型验证，但未触及真实源码！
```

### 目标状态（第三周结束）
```
/Users/jqwang/98-ghosttyAI/
├── tmux/              # 修改后的 tmux 源码
│   ├── tty.c         # ✓ 集成 backend router
│   ├── Makefile      # ✓ 构建 libtmuxcore.so
│   └── ui_backend/   # ✓ 新增接口层
├── ghostty/           # 修改后的 Ghostty 源码  
│   ├── src/tmux/     # ✓ libtmuxcore 集成
│   ├── build.zig     # ✓ 链接 libtmuxcore
│   └── src/terminal/ # ✓ 使用 tmux callbacks
└── libtmuxcore.so    # ✓ 可分发动态库
```

---

## 📋 第三周核心任务 - 从原型到生产

### Phase 1: tmux 源码修改（Day 1-2）

#### T-301-R: tmux 源码集成 backend router
**负责人**: c-tmux-specialist  
**工期**: 2天  
**关键修改**:

```c
// 修改 /Users/jqwang/98-ghosttyAI/tmux/tty.c
// Line 1234 附近，添加路由机制
void tty_write(void (*cmdfn)(struct tty *, const struct tty_ctx *),
              struct tty_ctx *ctx) {
    // NEW: 集成 cache/week2 的 backend router
    #ifdef LIBTMUXCORE_BUILD
    if (ctx->tty->backend && ui_backend_enabled()) {
        ui_backend_dispatch(ctx->tty->backend, cmdfn, ctx);
        return;
    }
    #endif
    // Original path
    (*cmdfn)(ctx->tty, ctx);
}
```

**交付物**:
1. 修改 tmux/tty.c - 集成 backend router
2. 创建 tmux/ui_backend/ 目录结构
3. 修改 tmux/Makefile 支持 libtmuxcore 构建

---

#### T-302-R: 构建 libtmuxcore 动态库
**负责人**: libtmux-core-developer  
**工期**: 1天  
**依赖**: T-301-R  

```makefile
# 新增 tmux/Makefile.libtmuxcore
libtmuxcore.so: $(LIBTMUX_OBJS)
    $(CC) -shared -fPIC \
          -Wl,--version-script=libtmuxcore.sym \
          -o $@ $^ \
          -DLIBTMUXCORE_BUILD

install-lib:
    cp libtmuxcore.so /usr/local/lib/
    cp libtmuxcore.h /usr/local/include/
    ldconfig
```

**交付物**:
1. libtmuxcore.so.1.0.0 动态库
2. libtmuxcore.h 公共头文件
3. libtmuxcore.pc pkg-config 文件

---

### Phase 2: Ghostty 源码集成（Day 3-4）

#### T-303-R: Ghostty 创建 tmux 集成模块
**负责人**: zig-ghostty-integration  
**工期**: 2天  
**关键集成**:

```zig
// 创建 /Users/jqwang/98-ghosttyAI/ghostty/src/tmux/core.zig
const std = @import("std");
const c = @cImport({
    @cInclude("libtmuxcore.h");
});

pub const TmuxCore = struct {
    handle: *c.tmc_handle_t,
    callbacks: Callbacks,
    
    pub fn init(allocator: std.mem.Allocator) !TmuxCore {
        // 从 cache/week2/INTG-001 迁移代码
        const handle = c.tmc_init() orelse return error.InitFailed;
        
        // 注册回调
        c.tmc_register_callbacks(handle, &vtable);
        
        return TmuxCore{
            .handle = handle,
            .callbacks = Callbacks.init(allocator),
        };
    }
};
```

**修改 build.zig**:
```zig
// 修改 ghostty/build.zig
exe.addLibraryPath("/usr/local/lib");
exe.linkSystemLibrary("tmuxcore");
exe.addIncludePath("/usr/local/include");
```

---

#### T-304-R: Terminal 模块集成 tmux callbacks
**负责人**: integration-dev  
**工期**: 1天  
**依赖**: T-303-R  

```zig
// 修改 ghostty/src/terminal/Terminal.zig
const TmuxCore = @import("../tmux/core.zig").TmuxCore;

pub const Terminal = struct {
    // 新增字段
    tmux_core: ?TmuxCore,
    tmux_enabled: bool,
    
    pub fn init(allocator: std.mem.Allocator) !Terminal {
        var self = Terminal{
            // ... existing fields
            .tmux_core = null,
            .tmux_enabled = false,
        };
        
        // 条件初始化 tmux
        if (config.enable_tmux) {
            self.tmux_core = try TmuxCore.init(allocator);
            self.tmux_enabled = true;
        }
        
        return self;
    }
    
    // 新增：处理 tmux 命令
    pub fn handleTmuxCommand(self: *Terminal, cmd: []const u8) !void {
        if (self.tmux_core) |*tmux| {
            try tmux.executeCommand(cmd);
        }
    }
};
```

---

### Phase 3: 集成验证与测试（Day 5）

#### T-305-R: 端到端集成测试
**负责人**: qa-test-engineer  
**工期**: 1天  
**测试范围**:

1. **构建验证**
   ```bash
   # tmux 动态库构建
   cd /Users/jqwang/98-ghosttyAI/tmux
   make -f Makefile.libtmuxcore
   sudo make -f Makefile.libtmuxcore install
   
   # Ghostty 链接验证
   cd /Users/jqwang/98-ghosttyAI/ghostty
   zig build
   ```

2. **功能测试**
   - tmux 基本命令（new-session, split-window）
   - 网格渲染正确性
   - 性能基准测试
   - 内存泄漏检查

3. **兼容性测试**
   - vim/neovim 在 tmux 中运行
   - htop 显示正确
   - 复制模式工作

---

## 🔄 从原型到生产的迁移策略

### 代码迁移路径
```
cache/week2/CORE-001/event_loop_backend.h
    ↓ (复制并适配)
tmux/ui_backend/event_loop_backend.h

cache/week2/INTG-001/callbacks.zig  
    ↓ (重构并集成)
ghostty/src/tmux/callbacks.zig

cache/week2/CORE-002/grid_operations_avx2.c
    ↓ (优化并合并)
tmux/grid_simd.c
```

### 关键集成点检查清单

| 集成点 | 文件位置 | 修改类型 | 风险等级 |
|--------|----------|----------|----------|
| tty_write 拦截 | tmux/tty.c:1234 | 添加条件编译 | 高 |
| Backend vtable | tmux/ui_backend.h | 新增文件 | 低 |
| Makefile 修改 | tmux/Makefile | 添加 libtmuxcore 目标 | 中 |
| Ghostty tmux 模块 | ghostty/src/tmux/ | 新增目录 | 低 |
| build.zig 链接 | ghostty/build.zig | 添加库依赖 | 中 |
| Terminal 集成 | ghostty/src/terminal/Terminal.zig | 修改现有代码 | 高 |

---

## 📊 风险评估与缓解

### 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| tmux 源码修改破坏兼容性 | 高 | 高 | 条件编译，保留原路径 |
| Ghostty 构建失败 | 中 | 高 | 渐进式集成，功能开关 |
| 性能退化 | 低 | 高 | 基准测试，profile 分析 |
| 内存泄漏 | 中 | 中 | Valgrind 持续监控 |

### 进度风险

| 风险 | 缓解措施 |
|------|----------|
| 源码修改比预期复杂 | 保留 fallback 到传统 TTY |
| 构建系统集成困难 | 先静态链接，后改动态 |
| 测试发现严重问题 | 保留一天 buffer 修复 |

---

## 🎯 第三周成功标准（修订版）

### 必须达成 (P0)
- [ ] libtmuxcore.so 成功构建并可加载
- [ ] Ghostty 成功链接 libtmuxcore
- [ ] 基本 tmux 命令可执行（new, split）
- [ ] 无崩溃，无内存泄漏

### 应该达成 (P1)  
- [ ] 性能达到 60 FPS
- [ ] vim/neovim 正常工作
- [ ] 复制模式可用
- [ ] 文档更新完成

### 可以达成 (P2)
- [ ] HiDPI 支持
- [ ] 会话持久化
- [ ] CI/CD 集成
- [ ] 包管理器支持

---

## 📅 详细时间线

### Day 1 (周一)
- 09:00 - 12:00: T-301-R tmux 源码分析与规划
- 14:00 - 18:00: T-301-R 实施 tty.c 修改

### Day 2 (周二)  
- 09:00 - 12:00: T-301-R 完成 ui_backend 结构
- 14:00 - 18:00: T-302-R 构建 libtmuxcore.so

### Day 3 (周三)
- 09:00 - 12:00: T-303-R Ghostty tmux 模块创建
- 14:00 - 18:00: T-303-R 回调系统集成

### Day 4 (周四)
- 09:00 - 12:00: T-304-R Terminal 模块集成
- 14:00 - 18:00: T-304-R 调试与初步测试

### Day 5 (周五)
- 09:00 - 12:00: T-305-R 集成测试
- 14:00 - 16:00: Bug 修复
- 16:00 - 18:00: Demo 准备与文档

---

## 🚀 执行建议

### 给项目经理
1. **优先级调整**: 先完成 P0 任务，确保基本集成
2. **风险控制**: 每个修改都要有 fallback 方案
3. **持续验证**: 每完成一个集成点立即测试
4. **文档同步**: 修改代码同时更新文档

### 给开发团队
1. **保留原型代码**: cache/week2 作为参考，不要删除
2. **小步快跑**: 每个 commit 都要可编译可运行
3. **充分测试**: 修改源码前先写测试
4. **及时沟通**: 遇到问题立即上报

### 给架构师
1. **审核集成点**: 重点审查 tty.c 和 Terminal.zig 修改
2. **性能监控**: 确保集成不影响性能
3. **接口设计**: 确保 API 向后兼容
4. **安全审计**: 检查内存管理和错误处理

---

## 📝 总结

第三周的核心任务是将第二周的原型成果真正集成到 tmux 和 Ghostty 源码中。这需要：

1. **谨慎修改源码** - 使用条件编译保护
2. **渐进式集成** - 先核心功能，后高级特性
3. **充分测试** - 每步都要验证
4. **保留退路** - 随时可回滚到传统模式

**关键成功因素**：
- 源码修改的精确性
- 构建系统的正确配置
- 集成测试的全面性
- 团队协作的紧密性

---

**文档状态**: 待架构师评审  
**下一步**: 部署给 system-architect (Window 1) 进行技术评审