# 第五周任务分配清单 (Week 5 Task Allocation)

## 执行概要 (Executive Summary)
**Week 5 Focus**: 将原型转化为生产代码，实现真实的tmux-Ghostty集成  
**Executor**: Single Agent Model (week5-production-integrator)  
**Timeline**: 5 days (Monday-Friday)  
**Milestone**: Working tmux sessions in Ghostty

## 📋 Task Breakdown by Day

### Day 1 (Monday) - Core Integration
**Morning Block (4 hours)**
```
Task: T-501-A - Modify screen-write.c
Location: /Users/jqwang/98-ghosttyAI/tmux/screen-write.c
Actions:
1. Add ui_cmd_id field includes
2. Find all tty_write calls (grep -n "tty_write")
3. Add ctx.ui_cmd_id = TTY_CMD_* before each call
4. Wrap changes in #ifdef LIBTMUXCORE_BUILD
Deliverable: screen-write.c with 15+ modified call sites
Test: Compile tmux, run test_minimal_dispatch
```

**Afternoon Block (4 hours)**
```
Task: T-501-B - Update tmux.h headers
Location: /Users/jqwang/98-ghosttyAI/tmux/tmux.h
Actions:
1. Add command ID enum definition
2. Update tty_ctx structure (if not using minimal)
3. Ensure backward compatibility
Deliverable: Updated headers with command IDs
Test: Full tmux build without warnings
```

### Day 2 (Tuesday) - Ghostty Integration
**Morning Block (4 hours)**
```
Task: T-502-A - Connect Terminal.zig
Location: /Users/jqwang/98-ghosttyAI/ghostty/src/Terminal.zig
Actions:
1. Import tmux/ffi_bridge.zig
2. Add callback registration in init()
3. Implement onTmuxCell handler
4. Connect grid update logic
Deliverable: Terminal.zig with tmux callbacks
Test: Zig build passes, callbacks triggered
```

**Afternoon Block (4 hours)**
```
Task: T-502-B - Test first integration
Actions:
1. Build modified tmux as library
2. Build Ghostty with tmux support
3. Run simple echo test
4. Verify text appears in Ghostty
Deliverable: Working "Hello from tmux" in Ghostty
Evidence: Screenshot of working output
```

### Day 3 (Wednesday) - Session Management
**Morning Block (4 hours)**
```
Task: T-503 - Implement session manager
Location: Create /ghostty/src/tmux/session_manager.zig
Actions:
1. Define SessionManager struct
2. Implement createSession function
3. Implement attachSession function
4. Add session lifecycle methods
Deliverable: session_manager.zig
Test: Unit tests for session operations
```

**Afternoon Block (4 hours)**
```
Task: T-504 - Add persistence layer
Location: Create /ghostty/src/tmux/persistence.zig
Actions:
1. Define persistence format (JSON/SQLite)
2. Implement save_session function
3. Implement restore_session function
4. Hook into Ghostty shutdown/startup
Deliverable: persistence.zig with save/restore
Test: Session survives Ghostty restart
```

### Day 4 (Thursday) - Testing & Performance
**Morning Block (4 hours)**
```
Task: T-505 - End-to-end testing
Location: Create test_e2e_integration.c
Actions:
1. Test tmux new-session in Ghostty
2. Test command execution (ls, vim, etc.)
3. Test session switching
4. Test persistence across restart
Deliverable: Comprehensive E2E test suite
Result: All tests passing
```

**Afternoon Block (4 hours)**
```
Task: T-506 - Performance optimization
Actions:
1. Profile callback overhead
2. Implement cell batching
3. Add dirty region optimization
4. Tune update frequency
Deliverable: Performance report
Target: <10ms latency achieved
```

### Day 5 (Friday) - Production Hardening
**Morning Block (4 hours)**
```
Task: T-507 - Error handling
Actions:
1. Add try-catch in Zig code
2. Graceful fallback if tmux unavailable
3. Memory leak fixes
4. Logging and diagnostics
Deliverable: Robust error handling
Test: Stress test for 1 hour
```

**Afternoon Block (4 hours)**
```
Task: T-508 - Documentation & Demo
Actions:
1. Update README with tmux integration
2. Create user guide
3. Record demo video
4. Prepare release notes
Deliverable: Complete documentation
Final: Working demo video
```

## 🎯 Critical Path Items

### Must Complete (P0)
1. T-501-A: screen-write.c modifications
2. T-502-A: Terminal.zig connection
3. T-502-B: First working integration
4. T-505: E2E testing

### Should Complete (P1)
1. T-503: Session management
2. T-504: Persistence
3. T-506: Performance optimization

### Nice to Have (P2)
1. T-507: Full error handling
2. T-508: Polish and documentation

## 📊 Progress Tracking

### Daily Checkpoints
```
Monday EOD:   [ ] screen-write.c modified
Tuesday EOD:  [ ] "Hello tmux" in Ghostty
Wednesday EOD:[ ] Sessions working
Thursday EOD: [ ] Performance targets met
Friday EOD:   [ ] Demo ready
```

### Success Metrics
```
Code Metrics:
- Lines modified: ~200 in tmux, ~300 in Ghostty
- New files: 4 (session_manager, persistence, tests)
- Test coverage: >80%

Performance Metrics:
- Character latency: <10ms
- Session switch: <100ms
- Memory overhead: <10MB
- CPU usage: <5% idle

Quality Metrics:
- Zero crashes in 1-hour test
- All E2E tests passing
- No memory leaks detected
```

## 🛠️ Build Commands

### Daily Build Sequence
```bash
# Morning: Build tmux library
cd /Users/jqwang/98-ghosttyAI
./build_week5_tmux.sh

# Test tmux changes
./test_tmux_dispatch

# Afternoon: Build Ghostty
cd ghostty
zig build -Doptimize=ReleaseSafe

# Integration test
./zig-out/bin/ghostty --tmux-test

# End of day: Full test suite
./run_all_tests.sh
```

## 🚨 Blocker Resolution

### If screen-write.c changes break tmux:
```bash
git checkout tmux/screen-write.c
# Use more conservative approach with fewer changes
```

### If Terminal.zig integration fails:
```bash
# Use simple stub first
# Gradually add complexity
# Check FFI bridge alignment
```

### If performance is poor:
```bash
# Profile with Instruments (macOS)
# Reduce callback frequency
# Batch updates
```

## 📝 Daily Reports Template

```markdown
## Day X Report - [Date]

### Completed Tasks
- T-XXX: [Description] ✅

### Current Status
- Integration: [Working/Partial/Blocked]
- Tests: [X/Y passing]
- Performance: [Xms latency]

### Blockers
- [Issue description]

### Next Steps
- [Tomorrow's priority]

### Evidence
- [Screenshot/Log/Metrics]
```

## 🎬 Friday Demo Script

```bash
# 1. Show Ghostty without tmux
ghostty
echo "Normal Ghostty terminal"
exit

# 2. Enable tmux integration
export GHOSTTY_TMUX_ENABLED=1
ghostty

# 3. Create tmux session
tmux new -s demo
echo "Now running inside tmux!"

# 4. Show persistence
echo "Important work here"
# Force quit Ghostty (Cmd+Q)

# 5. Restore session
ghostty
tmux attach -t demo
# "Important work here" is still visible!

# 6. Performance demo
time echo "Performance test"
# Should show <10ms

# 7. Multiple sessions
tmux new -s dev
tmux new -s prod
tmux ls
# Switch between sessions seamlessly
```

## 🏁 Week 5 Completion Criteria

- [ ] Modified tmux compiles and runs
- [ ] Ghostty receives tmux callbacks
- [ ] Text displays correctly in Ghostty
- [ ] Sessions persist across restarts
- [ ] Performance meets targets
- [ ] No memory leaks
- [ ] E2E tests pass
- [ ] Demo video recorded

---

**Ready for Production Integration! 🚀**