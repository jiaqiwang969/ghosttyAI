# 第五周施工方案 - 实用集成版 (Practical Integration Plan)

## 📌 Week 5 Mission Statement
**将已验证的callback系统集成到真实的tmux和Ghostty源码中，实现端到端的会话持久化**  
Integrate the proven callback system into actual tmux and Ghostty source code for end-to-end session persistence.

## 🎯 Week 5 Core Objectives

### Primary Goal
Transform prototype into production: Move from `test_minimal_dispatch.c` proof-of-concept to real tmux session rendering in Ghostty.

### Success Criteria
- [ ] Real tmux commands display output in Ghostty terminal
- [ ] Session persists across Ghostty restarts  
- [ ] Performance: <10ms latency for character display
- [ ] Zero memory leaks in 1-hour stress test

## 📊 Current State Analysis

### ✅ What We Have (Week 4 Achievements)
```
1. Working callback dispatch with command IDs
2. libtmuxcore.dylib (52KB) successfully built
3. UI Backend infrastructure in place
4. FFI bridge prepared (ffi_bridge.zig)
5. Test proves "Hello from tmux" works
```

### ❌ What's Missing for Production
```
1. screen-write.c not setting ui_cmd_id
2. Terminal.zig not connected to callbacks
3. Real tmux session integration absent
4. No session persistence implementation
5. Performance optimizations needed
```

## 🏗️ Week 5 Implementation Tasks

### Phase 1: Source Code Integration (Days 1-2)

#### T-501: Modify tmux screen-write.c
**File**: `/Users/jqwang/98-ghosttyAI/tmux/screen-write.c`
```c
// Add command ID setting before tty_write calls
static void screen_write_set_cell(struct screen_write_ctx *ctx, ...) {
    // Existing code...
    tty_ctx.ui_cmd_id = TTY_CMD_CELL;  // NEW: Set command ID
    tty_write(tty_cmd_cell, &tty_ctx);
}
```

**Scope**: 
- Modify ~15 call sites in screen-write.c
- Add ui_cmd_id setting for each tty_cmd_* function
- Maintain backward compatibility with #ifdef LIBTMUXCORE_BUILD

#### T-502: Connect Terminal.zig to FFI callbacks
**File**: `/Users/jqwang/98-ghosttyAI/ghostty/src/Terminal.zig`
```zig
// Import our FFI bridge
const tmux_ffi = @import("tmux/ffi_bridge.zig");

// Initialize tmux callbacks in Terminal.init
pub fn init(self: *Terminal) !void {
    // Existing initialization...
    
    // NEW: Register tmux callbacks
    try tmux_ffi.CallbackHandler.init(self.allocator);
    tmux_ffi.registerCallbacks(self);
}

// Handle tmux cell output
fn onTmuxCell(ch: u8, row: i32, col: i32, ...) void {
    self.grid.setCell(row, col, ch, attrs);
    self.markDirty(row, col, 1, 1);
}
```

### Phase 2: Session Management (Days 2-3)

#### T-503: Implement tmux session creation
**New File**: `/Users/jqwang/98-ghosttyAI/ghostty/src/tmux/session_manager.zig`
```zig
pub const SessionManager = struct {
    sessions: std.HashMap([]const u8, *c.tmux_session),
    active_session: ?*c.tmux_session,
    
    pub fn createSession(self: *SessionManager, name: []const u8) !void {
        const session = c.tmux_new_session(name.ptr);
        try self.sessions.put(name, session);
    }
    
    pub fn attachSession(self: *SessionManager, name: []const u8) !void {
        if (self.sessions.get(name)) |session| {
            self.active_session = session;
            c.ui_backend_attach(session);
        }
    }
};
```

#### T-504: Add session persistence
**File**: `/Users/jqwang/98-ghosttyAI/ghostty/src/config.zig`
```zig
// Add tmux session configuration
pub const TmuxConfig = struct {
    enabled: bool = false,
    session_name: []const u8 = "ghostty-default",
    persist_on_exit: bool = true,
    socket_path: []const u8 = "/tmp/ghostty-tmux",
};
```

### Phase 3: Testing & Optimization (Days 3-4)

#### T-505: Create end-to-end test
**New File**: `/Users/jqwang/98-ghosttyAI/test_e2e_integration.c`
```c
// Test real tmux commands through Ghostty
void test_tmux_ls_command() {
    // Create tmux session
    tmux_session_t* session = tmux_new_session("test");
    
    // Execute ls command
    tmux_send_keys(session, "ls -la", TMUX_ENTER);
    
    // Verify output appears in callbacks
    assert(callback_buffer_contains("total"));
}
```

#### T-506: Performance optimization
- Implement cell batching (group adjacent cells)
- Add dirty region tracking
- Optimize callback frequency (max 60fps)
- Memory pool for callback data

### Phase 4: Production Hardening (Days 4-5)

#### T-507: Error handling & recovery
```zig
// Graceful degradation if tmux unavailable
const TmuxMode = enum {
    Embedded,    // Full libtmuxcore integration
    External,    // Fall back to external tmux
    Disabled,    // No tmux support
};
```

#### T-508: Configuration UI
- Add Ghostty preferences for tmux integration
- Toggle tmux mode on/off
- Session name configuration
- Keybinding customization

## 📁 File Modification Map

```
tmux/
├── screen-write.c        [MODIFY] Add ui_cmd_id setting
├── tmux.h               [MODIFY] Add command ID enum
└── session.c            [MODIFY] Export session functions

ghostty/
├── src/
│   ├── Terminal.zig     [MODIFY] Connect callbacks
│   ├── config.zig       [MODIFY] Add tmux config
│   └── tmux/
│       ├── ffi_bridge.zig      [ENHANCE] Production ready
│       ├── session_manager.zig  [CREATE] Session handling
│       └── persistence.zig      [CREATE] Save/restore

tests/
├── test_e2e_integration.c       [CREATE] End-to-end tests
└── benchmark_performance.c      [CREATE] Performance tests
```

## 🚀 Daily Execution Plan

### Monday - Source Integration
```bash
# Morning: Modify screen-write.c
cd /Users/jqwang/98-ghosttyAI/tmux
cp screen-write.c screen-write.c.bak
# Add ui_cmd_id to all tty_write call sites

# Afternoon: Test modified tmux
./build_week5.sh
./test_with_command_ids
```

### Tuesday - Ghostty Connection
```bash
# Morning: Connect Terminal.zig
cd /Users/jqwang/98-ghosttyAI/ghostty
# Integrate FFI callbacks

# Afternoon: First real test
zig build
./zig-out/bin/ghostty --tmux-mode
```

### Wednesday - Session Management
```bash
# Implement session creation/attachment
# Test persistence across restarts
```

### Thursday - Testing & Optimization
```bash
# Run performance benchmarks
# Optimize hot paths
# Fix any memory leaks
```

### Friday - Production Ready
```bash
# Error handling
# Documentation
# Final integration test
```

## 🎯 Week 5 Deliverables

1. **Modified tmux source** with ui_cmd_id properly set
2. **Connected Terminal.zig** receiving tmux callbacks  
3. **Working session management** with persistence
4. **Performance meeting targets** (<10ms latency)
5. **Comprehensive test suite** passing
6. **Documentation** for users and developers

## 📊 Risk Mitigation

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| screen-write.c changes break tmux | Low | High | Use #ifdef guards, extensive testing |
| Terminal.zig integration complex | Medium | Medium | Incremental integration, debug logging |
| Performance regression | Medium | High | Benchmark early, optimize iteratively |
| Session persistence issues | Low | Medium | SQLite fallback for state storage |

## 🔄 Rollback Plan

If integration causes instability:
1. Revert to external tmux mode (Week 5 backup)
2. Use environment variable to toggle: `GHOSTTY_TMUX_MODE=external`
3. Maintain compatibility layer for gradual migration

## 📈 Success Metrics

- **Functionality**: 100% of tmux commands work in Ghostty
- **Performance**: <10ms character latency, <100ms session switch
- **Stability**: 0 crashes in 24-hour test run
- **Memory**: <10MB overhead for tmux integration
- **User Experience**: Seamless tmux integration invisible to users

## 🎬 Week 5 Demo Scenario

```bash
# Start Ghostty with tmux integration
$ ghostty --tmux-enabled

# Create new session
$ tmux new -s dev

# Run commands that display in Ghostty
$ ls -la
$ vim hello.c
$ gcc hello.c && ./a.out
"Hello from tmux in Ghostty!"

# Quit Ghostty
$ exit

# Restart Ghostty, session persists
$ ghostty --tmux-enabled
$ tmux attach -t dev
# Previous session restored!
```

## 📝 Notes

- Focus on practical integration over perfect architecture
- Prioritize visible progress (working demo by Wednesday)
- Keep changes minimal and surgical
- Document every modification for future maintenance
- Test incrementally, don't wait until Friday

---

**Week 5 Motto**: "From Prototype to Production - Make it Real!"