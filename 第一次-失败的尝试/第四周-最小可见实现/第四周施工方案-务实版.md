# ç¬¬å››å‘¨æ–½å·¥æ–¹æ¡ˆ - æœ€å°å¯è§ç›®æ ‡ï¼šæ˜¾ç¤º "Hello from tmux"
# Week 4 Implementation Plan - Minimal Goal: Display "Hello from tmux"

**åˆ›å»ºæ—¶é—´**: 2025-08-26  
**ç‰ˆæœ¬**: 5.0 (åŠ¡å®ç‰ˆ)  
**æ ¸å¿ƒç›®æ ‡**: æ‰“é€šå›è°ƒé“¾è·¯ï¼Œèƒ½åœ¨ Ghostty ä¸­çœ‹åˆ° tmux çš„è¾“å‡º  
**æˆåŠŸæ ‡å‡†**: `echo "Hello from tmux"` èƒ½æ­£ç¡®æ˜¾ç¤º

---

## ğŸ¯ ç¬¬å››å‘¨æ ¸å¿ƒä»»åŠ¡ï¼šè¡¥å…¨ç¼ºå¤±çš„å…³é”®å®ç°

### ç°çŠ¶åˆ†æ
```
ç¬¬ä¸‰å‘¨å£°ç§°å®Œæˆä½†å®é™…ç¼ºå¤±ï¼š
âŒ UI Backend Router (åªæœ‰stub)
âŒ tty.c è·¯ç”±ä¿®æ”¹ (æ²¡æœ‰çœŸæ­£ä¿®æ”¹)
âŒ å›è°ƒé“¾è·¯ (å®Œå…¨æ–­å¼€)
âŒ Terminal.zig é›†æˆ (æ²¡æœ‰è°ƒç”¨tmux)
```

### æœ¬å‘¨ç›®æ ‡
```
æœ€å°å¯è§éªŒè¯ï¼š
âœ… tmux è¾“å‡º "Hello from tmux"
âœ… é€šè¿‡å›è°ƒä¼ é€’ç»™ Ghostty
âœ… Ghostty æ˜¾ç¤ºè¿™ä¸ªæ–‡æœ¬
```

---

## ğŸ“Š ç¬¬å››å‘¨è¯¦ç»†ä»»åŠ¡åˆ†è§£

### Day 1: å®ç°çœŸæ­£çš„ UI Backend Router

#### ä»»åŠ¡ W4-001: åˆ›å»ºçœŸæ­£èƒ½å·¥ä½œçš„ ui_backend.c
**ä½ç½®**: `tmux/ui_backend.c`
**ç›®æ ‡**: ä¸æ˜¯stubï¼Œæ˜¯çœŸæ­£çš„å®ç°

```c
// tmux/ui_backend.c - çœŸæ­£çš„å®ç°ï¼Œä¸æ˜¯stubï¼
#include "tmux.h"
#include <stdio.h>

// å…¨å±€å›è°ƒå‡½æ•°æŒ‡é’ˆ - ç®€å•ç›´æ¥
static void (*g_on_text_callback)(const char* text, size_t len) = NULL;
static void* g_user_data = NULL;

// UI Backend ç»“æ„
struct ui_backend {
    int enabled;
    // ç®€å•çš„æ–‡æœ¬ç¼“å†²åŒº
    char buffer[1024];
    size_t buffer_pos;
};

// å…¨å±€backendå®ä¾‹
static struct ui_backend g_backend = {
    .enabled = 0,
    .buffer = {0},
    .buffer_pos = 0
};

// åˆå§‹åŒ–backend
void ui_backend_init(void) {
    printf("[UI_BACKEND] Initializing...\n");
    g_backend.enabled = 1;
    g_backend.buffer_pos = 0;
}

// è®¾ç½®å›è°ƒ - è¿™æ˜¯è¿æ¥åˆ°Ghosttyçš„å…³é”®
void ui_backend_set_callback(void (*callback)(const char*, size_t), void* user_data) {
    printf("[UI_BACKEND] Setting callback: %p\n", callback);
    g_on_text_callback = callback;
    g_user_data = user_data;
}

// æ ¸å¿ƒå‡½æ•°ï¼šå¤„ç†tty_cmd_cell - æœ€é‡è¦çš„å‡½æ•°
void ui_backend_cell(struct tty_ctx* ctx) {
    if (!g_backend.enabled) return;
    
    struct grid_cell* gc = ctx->cell;
    if (gc == NULL) return;
    
    // æå–å­—ç¬¦
    char ch = gc->data.data[0];
    if (ch == 0) return;
    
    printf("[UI_BACKEND] Got cell: '%c' (0x%02x)\n", ch, ch);
    
    // æ·»åŠ åˆ°ç¼“å†²åŒº
    if (g_backend.buffer_pos < sizeof(g_backend.buffer) - 1) {
        g_backend.buffer[g_backend.buffer_pos++] = ch;
    }
    
    // å¦‚æœæ˜¯æ¢è¡Œç¬¦æˆ–ç¼“å†²åŒºæ»¡ï¼Œåˆ·æ–°
    if (ch == '\n' || g_backend.buffer_pos >= sizeof(g_backend.buffer) - 1) {
        ui_backend_flush();
    }
}

// åˆ·æ–°ç¼“å†²åŒº - è§¦å‘å›è°ƒ
void ui_backend_flush(void) {
    if (g_backend.buffer_pos == 0) return;
    
    g_backend.buffer[g_backend.buffer_pos] = '\0';
    printf("[UI_BACKEND] Flushing: '%s'\n", g_backend.buffer);
    
    // è°ƒç”¨å›è°ƒ - å‘é€ç»™Ghosttyï¼
    if (g_on_text_callback != NULL) {
        g_on_text_callback(g_backend.buffer, g_backend.buffer_pos);
    }
    
    // æ¸…ç©ºç¼“å†²åŒº
    g_backend.buffer_pos = 0;
}

// æ£€æŸ¥æ˜¯å¦å¯ç”¨
int ui_backend_enabled(void) {
    return g_backend.enabled;
}
```

### Day 2: ä¿®æ”¹ tty.c æ·»åŠ çœŸæ­£çš„è·¯ç”±

#### ä»»åŠ¡ W4-002: ä¿®æ”¹ tty.c å®ç°è·¯ç”±
**ä½ç½®**: `tmux/tty.c`
**ç›®æ ‡**: çœŸæ­£æ‹¦æˆª tty_write å¹¶è·¯ç”±åˆ° backend

```c
// tmux/tty.c - åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ 
#ifdef LIBTMUXCORE_BUILD
#include "ui_backend.h"
extern void ui_backend_cell(struct tty_ctx* ctx);
extern int ui_backend_enabled(void);
#endif

// æ‰¾åˆ° tty_cmd_cell å‡½æ•°å¹¶ä¿®æ”¹
void
tty_cmd_cell(struct tty *tty, const struct tty_ctx *ctx)
{
    #ifdef LIBTMUXCORE_BUILD
    // å¦‚æœUI Backendå¯ç”¨ï¼Œè·¯ç”±åˆ°backend
    if (ui_backend_enabled()) {
        printf("[TTY] Routing cell to UI Backend\n");
        ui_backend_cell((struct tty_ctx*)ctx);
        return;  // ä¸æ‰§è¡ŒåŸæœ‰çš„TTYè¾“å‡ºï¼
    }
    #endif
    
    // åŸæœ‰çš„TTYè¾“å‡ºä»£ç ...
    if (!tty_is_visible(tty, ctx, ctx->ocx, ctx->ocy, 1, 1))
        return;
    // ... åŸæœ‰ä»£ç ç»§ç»­
}

// æ‰¾åˆ° tty_cmd_insertcharacter ç­‰å…¶ä»–å‡½æ•°ï¼Œä¹Ÿæ·»åŠ ç±»ä¼¼è·¯ç”±
// ä½†ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å…ˆåªå¤„ç† cell
```

### Day 3: åˆ›å»º Ghostty ç«¯çš„å›è°ƒæ¥æ”¶å™¨

#### ä»»åŠ¡ W4-003: å®ç° Ghostty å›è°ƒå¤„ç†
**ä½ç½®**: `ghostty/src/tmux/simple_callback.zig`
**ç›®æ ‡**: æœ€ç®€å•çš„å›è°ƒå¤„ç†ï¼Œèƒ½æ˜¾ç¤ºæ–‡æœ¬å°±è¡Œ

```zig
// ghostty/src/tmux/simple_callback.zig
const std = @import("std");
const c = @cImport({
    @cInclude("libtmuxcore.h");
});

// ç®€å•çš„å›è°ƒå¤„ç†å™¨
pub const SimpleCallback = struct {
    received_text: std.ArrayList(u8),
    
    pub fn init(allocator: std.mem.Allocator) SimpleCallback {
        return .{
            .received_text = std.ArrayList(u8).init(allocator),
        };
    }
    
    pub fn deinit(self: *SimpleCallback) void {
        self.received_text.deinit();
    }
    
    // Cå›è°ƒå‡½æ•° - æ¥æ”¶æ¥è‡ªtmuxçš„æ–‡æœ¬
    pub fn onTextCallback(
        text: [*c]const u8,
        len: usize,
        user_data: ?*anyopaque,
    ) callconv(.C) void {
        const self = @ptrCast(*SimpleCallback, @alignCast(@alignOf(SimpleCallback), user_data));
        
        // æ‰“å°è°ƒè¯•ä¿¡æ¯
        std.debug.print("[GHOSTTY] Received from tmux: {s}\n", .{text[0..len]});
        
        // ä¿å­˜æ–‡æœ¬
        self.received_text.appendSlice(text[0..len]) catch {
            std.debug.print("[GHOSTTY] Failed to append text\n", .{});
        };
    }
    
    pub fn getText(self: *SimpleCallback) []const u8 {
        return self.received_text.items;
    }
    
    pub fn clear(self: *SimpleCallback) void {
        self.received_text.clearRetainingCapacity();
    }
};
```

### Day 4: ä¿®æ”¹ Terminal.zig é›†æˆå›è°ƒ

#### ä»»åŠ¡ W4-004: è®© Terminal.zig çœŸæ­£ä½¿ç”¨ tmux
**ä½ç½®**: `ghostty/src/terminal/Terminal.zig`
**ç›®æ ‡**: åˆå§‹åŒ– tmux å¹¶æ˜¾ç¤ºå…¶è¾“å‡º

```zig
// ghostty/src/terminal/Terminal.zig - æ·»åŠ tmuxé›†æˆ
const std = @import("std");
const SimpleCallback = @import("../tmux/simple_callback.zig").SimpleCallback;

// å£°æ˜å¤–éƒ¨Cå‡½æ•°
extern fn ui_backend_init() void;
extern fn ui_backend_set_callback(
    callback: *const fn([*c]const u8, usize) callconv(.C) void,
    user_data: ?*anyopaque
) void;
extern fn tmc_create() ?*anyopaque;
extern fn tmc_initialize(ctx: ?*anyopaque) c_int;

pub const Terminal = struct {
    // åŸæœ‰å­—æ®µ
    allocator: std.mem.Allocator,
    cols: u32,
    rows: u32,
    grid: [][]Cell,
    
    // æ–°å¢ï¼štmuxé›†æˆ
    tmux_enabled: bool,
    tmux_callback: ?*SimpleCallback,
    tmux_context: ?*anyopaque,
    
    pub fn init(allocator: std.mem.Allocator, cols: u32, rows: u32) !Terminal {
        var self = Terminal{
            .allocator = allocator,
            .cols = cols,
            .rows = rows,
            .grid = try allocator.alloc([]Cell, rows),
            .tmux_enabled = false,
            .tmux_callback = null,
            .tmux_context = null,
        };
        
        // åˆå§‹åŒ–grid
        for (self.grid) |*row| {
            row.* = try allocator.alloc(Cell, cols);
            for (row.*) |*cell| {
                cell.* = Cell{ .char = ' ', .fg = 7, .bg = 0 };
            }
        }
        
        // æ£€æŸ¥ç¯å¢ƒå˜é‡
        if (std.process.getEnv("GHOSTTY_TMUX")) |_| {
            std.debug.print("[TERMINAL] Enabling tmux mode\n", .{});
            try self.initTmux();
        }
        
        return self;
    }
    
    fn initTmux(self: *Terminal) !void {
        // åˆå§‹åŒ–UI Backend
        ui_backend_init();
        
        // åˆ›å»ºå›è°ƒå¤„ç†å™¨
        self.tmux_callback = try self.allocator.create(SimpleCallback);
        self.tmux_callback.?.* = SimpleCallback.init(self.allocator);
        
        // è®¾ç½®å›è°ƒ
        ui_backend_set_callback(
            SimpleCallback.onTextCallback,
            self.tmux_callback,
        );
        
        // åˆ›å»ºtmux context
        self.tmux_context = tmc_create();
        if (self.tmux_context == null) {
            std.debug.print("[TERMINAL] Failed to create tmux context\n", .{});
            return;
        }
        
        // åˆå§‹åŒ–tmux
        const result = tmc_initialize(self.tmux_context);
        if (result != 0) {
            std.debug.print("[TERMINAL] Failed to initialize tmux\n", .{});
            return;
        }
        
        self.tmux_enabled = true;
        std.debug.print("[TERMINAL] tmux mode initialized!\n", .{});
    }
    
    pub fn render(self: *Terminal) void {
        if (self.tmux_enabled and self.tmux_callback != null) {
            // è·å–tmuxçš„è¾“å‡º
            const text = self.tmux_callback.?.getText();
            if (text.len > 0) {
                std.debug.print("[RENDER] Displaying tmux output: {s}\n", .{text});
                
                // ç®€å•åœ°å°†æ–‡æœ¬æ˜¾ç¤ºåœ¨ç¬¬ä¸€è¡Œ
                var col: u32 = 0;
                for (text) |ch| {
                    if (col >= self.cols or ch == '\n') break;
                    self.grid[0][col].char = ch;
                    col += 1;
                }
                
                // æ¸…ç©ºå·²å¤„ç†çš„æ–‡æœ¬
                self.tmux_callback.?.clear();
            }
        }
        
        // æ¸²æŸ“gridåˆ°å±å¹•
        self.renderGrid();
    }
    
    fn renderGrid(self: *Terminal) void {
        std.debug.print("\n--- Terminal Display ---\n", .{});
        for (self.grid) |row| {
            for (row) |cell| {
                std.debug.print("{c}", .{cell.char});
            }
            std.debug.print("\n", .{});
        }
        std.debug.print("--- End Display ---\n", .{});
    }
};

const Cell = struct {
    char: u8,
    fg: u8,
    bg: u8,
};
```

### Day 5: åˆ›å»ºæµ‹è¯•ç¨‹åº

#### ä»»åŠ¡ W4-005: åˆ›å»ºç®€å•çš„æµ‹è¯•ç¨‹åº
**ä½ç½®**: `test_hello_tmux.c`
**ç›®æ ‡**: éªŒè¯æ•´ä¸ªé“¾è·¯

```c
// test_hello_tmux.c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "libtmuxcore.h"

// å¤–éƒ¨å‡½æ•°å£°æ˜
extern void ui_backend_init(void);
extern void ui_backend_flush(void);

// å›è°ƒå‡½æ•° - æ‰“å°æ”¶åˆ°çš„æ–‡æœ¬
void on_text_callback(const char* text, size_t len) {
    printf("[TEST] Callback received: '%.*s'\n", (int)len, text);
}

int main() {
    printf("=== Testing tmux Hello World ===\n");
    
    // åˆå§‹åŒ–UI Backend
    ui_backend_init();
    ui_backend_set_callback(on_text_callback, NULL);
    
    // åˆ›å»ºtmux context
    tmc_context_t* ctx = tmc_create();
    if (!ctx) {
        printf("Failed to create tmux context\n");
        return 1;
    }
    
    // åˆå§‹åŒ–
    if (tmc_initialize(ctx, NULL) != 0) {
        printf("Failed to initialize tmux\n");
        return 1;
    }
    
    // å‘é€æµ‹è¯•æ–‡æœ¬
    const char* test_text = "Hello from tmux\n";
    printf("Sending: %s", test_text);
    tmc_process_input(ctx, test_text, strlen(test_text));
    
    // å¼ºåˆ¶åˆ·æ–°
    ui_backend_flush();
    
    // æ¸…ç†
    tmc_destroy(ctx);
    
    printf("=== Test Complete ===\n");
    return 0;
}
```

### Day 6: ç¼–è¯‘å’Œæµ‹è¯•è„šæœ¬

#### ä»»åŠ¡ W4-006: åˆ›å»ºæ„å»ºå’Œæµ‹è¯•è„šæœ¬
**ä½ç½®**: `week4_test.sh`
**ç›®æ ‡**: è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•

```bash
#!/bin/bash
set -e

echo "=== Week 4 Test: Hello from tmux ==="

# Step 1: ç¼–è¯‘tmux with UI Backend
echo "[1/5] Compiling tmux with UI Backend..."
cd tmux
make clean
make CFLAGS="-DLIBTMUXCORE_BUILD -DUI_BACKEND_ENABLED" || {
    echo "Failed to compile tmux"
    exit 1
}

# Step 2: æ„å»ºlibtmuxcore.dylib
echo "[2/5] Building libtmuxcore.dylib..."
gcc -shared -fPIC -o libtmuxcore.dylib \
    ui_backend.c \
    libtmuxcore.c \
    -DLIBTMUXCORE_BUILD \
    -L. -ltmux \
    || {
    echo "Failed to build libtmuxcore.dylib"
    exit 1
}

# Step 3: ç¼–è¯‘æµ‹è¯•ç¨‹åº
echo "[3/5] Compiling test program..."
gcc -o test_hello_tmux test_hello_tmux.c \
    -L. -ltmuxcore \
    -DLIBTMUXCORE_BUILD \
    || {
    echo "Failed to compile test program"
    exit 1
}

# Step 4: è¿è¡ŒCæµ‹è¯•
echo "[4/5] Running C test..."
export DYLD_LIBRARY_PATH=.:$DYLD_LIBRARY_PATH
./test_hello_tmux

# Step 5: ç¼–è¯‘å’Œè¿è¡ŒGhosttyæµ‹è¯•
echo "[5/5] Testing with Ghostty..."
cd ../ghostty
zig build-exe src/test_terminal.zig \
    --library c \
    --library ../tmux/libtmuxcore.dylib \
    -DGHOSTTY_TMUX \
    || {
    echo "Failed to compile Ghostty test"
    exit 1
}

# è¿è¡ŒGhosttyæµ‹è¯•
GHOSTTY_TMUX=1 ./test_terminal

echo "=== Week 4 Test Complete ==="
echo "If you see 'Hello from tmux' above, the callback chain is working!"
```

---

## ğŸ¯ ç¬¬å››å‘¨æˆåŠŸæ ‡å‡†

### æœ€å°å¯è§ç›®æ ‡
1. âœ… è¿è¡Œæµ‹è¯•æ—¶èƒ½çœ‹åˆ° `[UI_BACKEND] Got cell: 'H'` ç­‰è°ƒè¯•è¾“å‡º
2. âœ… èƒ½çœ‹åˆ° `[GHOSTTY] Received from tmux: Hello from tmux`
3. âœ… æœ€ç»ˆèƒ½åœ¨ Terminal çš„ grid ä¸­çœ‹åˆ° "Hello from tmux"

### ä¸è¿½æ±‚çš„ç›®æ ‡ï¼ˆæœ¬å‘¨ï¼‰
- âŒ å®Œç¾çš„æ¸²æŸ“
- âŒ å¤æ‚çš„å¸ƒå±€
- âŒ é«˜æ€§èƒ½
- âŒ å®Œæ•´åŠŸèƒ½

---

## ğŸ“‹ æ¯æ—¥æ‰§è¡Œè®¡åˆ’

### Day 1 (å‘¨ä¸€)
- ä¸Šåˆï¼šå®ç° ui_backend.c
- ä¸‹åˆï¼šç¼–è¯‘æµ‹è¯•
- éªŒè¯ï¼š`ui_backend_init()` èƒ½è¢«è°ƒç”¨

### Day 2 (å‘¨äºŒ)
- ä¸Šåˆï¼šä¿®æ”¹ tty.c æ·»åŠ è·¯ç”±
- ä¸‹åˆï¼šé‡æ–°ç¼–è¯‘ tmux
- éªŒè¯ï¼šçœ‹åˆ° `[TTY] Routing cell to UI Backend` è¾“å‡º

### Day 3 (å‘¨ä¸‰)
- ä¸Šåˆï¼šå®ç° SimpleCallback.zig
- ä¸‹åˆï¼šç¼–è¯‘æµ‹è¯•
- éªŒè¯ï¼šå›è°ƒå‡½æ•°ç¼–è¯‘é€šè¿‡

### Day 4 (å‘¨å››)
- ä¸Šåˆï¼šä¿®æ”¹ Terminal.zig
- ä¸‹åˆï¼šé›†æˆæµ‹è¯•
- éªŒè¯ï¼štmuxåˆå§‹åŒ–æˆåŠŸ

### Day 5 (å‘¨äº”)
- ä¸Šåˆï¼šåˆ›å»ºæµ‹è¯•ç¨‹åº
- ä¸‹åˆï¼šè°ƒè¯•é“¾è·¯
- éªŒè¯ï¼šå›è°ƒè¢«è§¦å‘

### Day 6 (å‘¨å…­)
- ä¸Šåˆï¼šå®Œæ•´æµ‹è¯•
- ä¸‹åˆï¼šä¿®å¤é—®é¢˜
- éªŒè¯ï¼šçœ‹åˆ° "Hello from tmux"

---

## ğŸ’¡ è°ƒè¯•æŠ€å·§

### å¦‚æœçœ‹ä¸åˆ°è¾“å‡º
1. æ£€æŸ¥æ¯ä¸€æ­¥çš„ printf/debug.print è¾“å‡º
2. ç¡®è®¤ ui_backend_enabled() è¿”å› 1
3. ç¡®è®¤å›è°ƒå‡½æ•°æŒ‡é’ˆä¸ä¸º NULL
4. ç¡®è®¤ tty_cmd_cell è¢«è°ƒç”¨

### å¦‚æœç¨‹åºå´©æºƒ
1. ç”¨ lldb/gdb è°ƒè¯•
2. æ£€æŸ¥å‡½æ•°æŒ‡é’ˆæ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥å†…å­˜å¯¹é½é—®é¢˜
4. ç®€åŒ–åˆ°æœ€å°æµ‹è¯•ç”¨ä¾‹

---

## ğŸ‰ é¢„æœŸæˆæœ

ç¬¬å››å‘¨ç»“æŸæ—¶ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½ï¼š

```
$ ./test_hello_tmux
=== Testing tmux Hello World ===
[UI_BACKEND] Initializing...
[UI_BACKEND] Setting callback: 0x1234567890
Sending: Hello from tmux
[UI_BACKEND] Got cell: 'H' (0x48)
[UI_BACKEND] Got cell: 'e' (0x65)
[UI_BACKEND] Got cell: 'l' (0x6c)
...
[UI_BACKEND] Flushing: 'Hello from tmux'
[TEST] Callback received: 'Hello from tmux'
=== Test Complete ===
```

è¿™å°±æ˜¯æˆåŠŸï¼è™½ç„¶ç®€å•ï¼Œä½†è¯æ˜äº†æ•´ä¸ªæ¶æ„æ˜¯å¯è¡Œçš„ã€‚

---

**æ ¸å¿ƒç†å¿µ**: ä¸æ±‚å®Œç¾ï¼Œä½†æ±‚å¯è§ã€‚å…ˆè®©å®ƒå·¥ä½œï¼Œå†è®©å®ƒæ›´å¥½ï¼