# ç¬¬ä¸‰å‘¨æ–½å·¥è“å›¾ - çœŸå® Ghostty æºç é›†æˆç‰ˆ
# Week 3 Construction Blueprint - Real Ghostty Source Integration

**ç‰ˆæœ¬**: 2.0 (Revised)  
**åˆ›å»ºæ—¶é—´**: 2025-08-26 22:00  
**çŠ¶æ€**: å¾…æ¶æ„å¸ˆè¯„å®¡  

---

## ğŸš¨ å…³é”®å‘ç°ï¼šé›†æˆå·®è·åˆ†æ

### å½“å‰çŠ¶æ€ï¼ˆç¬¬äºŒå‘¨ç»“æŸï¼‰
```
cache/week2/
â”œâ”€â”€ CORE-001/          # âœ… Event loop vtable (prototype)
â”œâ”€â”€ CORE-002/          # âœ… Grid operations (prototype) 
â”œâ”€â”€ INTG-001/          # âœ… FFI bridge (prototype)
â”œâ”€â”€ INTG-002/          # âœ… Callback system (prototype)
â””â”€â”€ TESTS/             # âœ… 91% coverage (on prototypes)

Status: å®ŒæˆåŸå‹éªŒè¯ï¼Œä½†æœªè§¦åŠçœŸå®æºç ï¼
```

### ç›®æ ‡çŠ¶æ€ï¼ˆç¬¬ä¸‰å‘¨ç»“æŸï¼‰
```
/Users/jqwang/98-ghosttyAI/
â”œâ”€â”€ tmux/              # ä¿®æ”¹åçš„ tmux æºç 
â”‚   â”œâ”€â”€ tty.c         # âœ“ é›†æˆ backend router
â”‚   â”œâ”€â”€ Makefile      # âœ“ æ„å»º libtmuxcore.so
â”‚   â””â”€â”€ ui_backend/   # âœ“ æ–°å¢æ¥å£å±‚
â”œâ”€â”€ ghostty/           # ä¿®æ”¹åçš„ Ghostty æºç   
â”‚   â”œâ”€â”€ src/tmux/     # âœ“ libtmuxcore é›†æˆ
â”‚   â”œâ”€â”€ build.zig     # âœ“ é“¾æ¥ libtmuxcore
â”‚   â””â”€â”€ src/terminal/ # âœ“ ä½¿ç”¨ tmux callbacks
â””â”€â”€ libtmuxcore.so    # âœ“ å¯åˆ†å‘åŠ¨æ€åº“
```

---

## ğŸ“‹ ç¬¬ä¸‰å‘¨æ ¸å¿ƒä»»åŠ¡ - ä»åŸå‹åˆ°ç”Ÿäº§

### Phase 1: tmux æºç ä¿®æ”¹ï¼ˆDay 1-2ï¼‰

#### T-301-R: tmux æºç é›†æˆ backend router
**è´Ÿè´£äºº**: c-tmux-specialist  
**å·¥æœŸ**: 2å¤©  
**å…³é”®ä¿®æ”¹**:

```c
// ä¿®æ”¹ /Users/jqwang/98-ghosttyAI/tmux/tty.c
// Line 1234 é™„è¿‘ï¼Œæ·»åŠ è·¯ç”±æœºåˆ¶
void tty_write(void (*cmdfn)(struct tty *, const struct tty_ctx *),
              struct tty_ctx *ctx) {
    // NEW: é›†æˆ cache/week2 çš„ backend router
    #ifdef LIBTMUXCORE_BUILD
    if (ctx->tty->backend && ui_backend_enabled()) {
        ui_backend_dispatch(ctx->tty->backend, cmdfn, ctx);
        return;
    }
    #endif
    // Original path
    (*cmdfn)(ctx->tty, ctx);
}
```

**äº¤ä»˜ç‰©**:
1. ä¿®æ”¹ tmux/tty.c - é›†æˆ backend router
2. åˆ›å»º tmux/ui_backend/ ç›®å½•ç»“æ„
3. ä¿®æ”¹ tmux/Makefile æ”¯æŒ libtmuxcore æ„å»º

---

#### T-302-R: æ„å»º libtmuxcore åŠ¨æ€åº“
**è´Ÿè´£äºº**: libtmux-core-developer  
**å·¥æœŸ**: 1å¤©  
**ä¾èµ–**: T-301-R  

```makefile
# æ–°å¢ tmux/Makefile.libtmuxcore
libtmuxcore.so: $(LIBTMUX_OBJS)
    $(CC) -shared -fPIC \
          -Wl,--version-script=libtmuxcore.sym \
          -o $@ $^ \
          -DLIBTMUXCORE_BUILD

install-lib:
    cp libtmuxcore.so /usr/local/lib/
    cp libtmuxcore.h /usr/local/include/
    ldconfig
```

**äº¤ä»˜ç‰©**:
1. libtmuxcore.so.1.0.0 åŠ¨æ€åº“
2. libtmuxcore.h å…¬å…±å¤´æ–‡ä»¶
3. libtmuxcore.pc pkg-config æ–‡ä»¶

---

### Phase 2: Ghostty æºç é›†æˆï¼ˆDay 3-4ï¼‰

#### T-303-R: Ghostty åˆ›å»º tmux é›†æˆæ¨¡å—
**è´Ÿè´£äºº**: zig-ghostty-integration  
**å·¥æœŸ**: 2å¤©  
**å…³é”®é›†æˆ**:

```zig
// åˆ›å»º /Users/jqwang/98-ghosttyAI/ghostty/src/tmux/core.zig
const std = @import("std");
const c = @cImport({
    @cInclude("libtmuxcore.h");
});

pub const TmuxCore = struct {
    handle: *c.tmc_handle_t,
    callbacks: Callbacks,
    
    pub fn init(allocator: std.mem.Allocator) !TmuxCore {
        // ä» cache/week2/INTG-001 è¿ç§»ä»£ç 
        const handle = c.tmc_init() orelse return error.InitFailed;
        
        // æ³¨å†Œå›è°ƒ
        c.tmc_register_callbacks(handle, &vtable);
        
        return TmuxCore{
            .handle = handle,
            .callbacks = Callbacks.init(allocator),
        };
    }
};
```

**ä¿®æ”¹ build.zig**:
```zig
// ä¿®æ”¹ ghostty/build.zig
exe.addLibraryPath("/usr/local/lib");
exe.linkSystemLibrary("tmuxcore");
exe.addIncludePath("/usr/local/include");
```

---

#### T-304-R: Terminal æ¨¡å—é›†æˆ tmux callbacks
**è´Ÿè´£äºº**: integration-dev  
**å·¥æœŸ**: 1å¤©  
**ä¾èµ–**: T-303-R  

```zig
// ä¿®æ”¹ ghostty/src/terminal/Terminal.zig
const TmuxCore = @import("../tmux/core.zig").TmuxCore;

pub const Terminal = struct {
    // æ–°å¢å­—æ®µ
    tmux_core: ?TmuxCore,
    tmux_enabled: bool,
    
    pub fn init(allocator: std.mem.Allocator) !Terminal {
        var self = Terminal{
            // ... existing fields
            .tmux_core = null,
            .tmux_enabled = false,
        };
        
        // æ¡ä»¶åˆå§‹åŒ– tmux
        if (config.enable_tmux) {
            self.tmux_core = try TmuxCore.init(allocator);
            self.tmux_enabled = true;
        }
        
        return self;
    }
    
    // æ–°å¢ï¼šå¤„ç† tmux å‘½ä»¤
    pub fn handleTmuxCommand(self: *Terminal, cmd: []const u8) !void {
        if (self.tmux_core) |*tmux| {
            try tmux.executeCommand(cmd);
        }
    }
};
```

---

### Phase 3: é›†æˆéªŒè¯ä¸æµ‹è¯•ï¼ˆDay 5ï¼‰

#### T-305-R: ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
**è´Ÿè´£äºº**: qa-test-engineer  
**å·¥æœŸ**: 1å¤©  
**æµ‹è¯•èŒƒå›´**:

1. **æ„å»ºéªŒè¯**
   ```bash
   # tmux åŠ¨æ€åº“æ„å»º
   cd /Users/jqwang/98-ghosttyAI/tmux
   make -f Makefile.libtmuxcore
   sudo make -f Makefile.libtmuxcore install
   
   # Ghostty é“¾æ¥éªŒè¯
   cd /Users/jqwang/98-ghosttyAI/ghostty
   zig build
   ```

2. **åŠŸèƒ½æµ‹è¯•**
   - tmux åŸºæœ¬å‘½ä»¤ï¼ˆnew-session, split-windowï¼‰
   - ç½‘æ ¼æ¸²æŸ“æ­£ç¡®æ€§
   - æ€§èƒ½åŸºå‡†æµ‹è¯•
   - å†…å­˜æ³„æ¼æ£€æŸ¥

3. **å…¼å®¹æ€§æµ‹è¯•**
   - vim/neovim åœ¨ tmux ä¸­è¿è¡Œ
   - htop æ˜¾ç¤ºæ­£ç¡®
   - å¤åˆ¶æ¨¡å¼å·¥ä½œ

---

## ğŸ”„ ä»åŸå‹åˆ°ç”Ÿäº§çš„è¿ç§»ç­–ç•¥

### ä»£ç è¿ç§»è·¯å¾„
```
cache/week2/CORE-001/event_loop_backend.h
    â†“ (å¤åˆ¶å¹¶é€‚é…)
tmux/ui_backend/event_loop_backend.h

cache/week2/INTG-001/callbacks.zig  
    â†“ (é‡æ„å¹¶é›†æˆ)
ghostty/src/tmux/callbacks.zig

cache/week2/CORE-002/grid_operations_avx2.c
    â†“ (ä¼˜åŒ–å¹¶åˆå¹¶)
tmux/grid_simd.c
```

### å…³é”®é›†æˆç‚¹æ£€æŸ¥æ¸…å•

| é›†æˆç‚¹ | æ–‡ä»¶ä½ç½® | ä¿®æ”¹ç±»å‹ | é£é™©ç­‰çº§ |
|--------|----------|----------|----------|
| tty_write æ‹¦æˆª | tmux/tty.c:1234 | æ·»åŠ æ¡ä»¶ç¼–è¯‘ | é«˜ |
| Backend vtable | tmux/ui_backend.h | æ–°å¢æ–‡ä»¶ | ä½ |
| Makefile ä¿®æ”¹ | tmux/Makefile | æ·»åŠ  libtmuxcore ç›®æ ‡ | ä¸­ |
| Ghostty tmux æ¨¡å— | ghostty/src/tmux/ | æ–°å¢ç›®å½• | ä½ |
| build.zig é“¾æ¥ | ghostty/build.zig | æ·»åŠ åº“ä¾èµ– | ä¸­ |
| Terminal é›†æˆ | ghostty/src/terminal/Terminal.zig | ä¿®æ”¹ç°æœ‰ä»£ç  | é«˜ |

---

## ğŸ“Š é£é™©è¯„ä¼°ä¸ç¼“è§£

### æŠ€æœ¯é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| tmux æºç ä¿®æ”¹ç ´åå…¼å®¹æ€§ | é«˜ | é«˜ | æ¡ä»¶ç¼–è¯‘ï¼Œä¿ç•™åŸè·¯å¾„ |
| Ghostty æ„å»ºå¤±è´¥ | ä¸­ | é«˜ | æ¸è¿›å¼é›†æˆï¼ŒåŠŸèƒ½å¼€å…³ |
| æ€§èƒ½é€€åŒ– | ä½ | é«˜ | åŸºå‡†æµ‹è¯•ï¼Œprofile åˆ†æ |
| å†…å­˜æ³„æ¼ | ä¸­ | ä¸­ | Valgrind æŒç»­ç›‘æ§ |

### è¿›åº¦é£é™©

| é£é™© | ç¼“è§£æªæ–½ |
|------|----------|
| æºç ä¿®æ”¹æ¯”é¢„æœŸå¤æ‚ | ä¿ç•™ fallback åˆ°ä¼ ç»Ÿ TTY |
| æ„å»ºç³»ç»Ÿé›†æˆå›°éš¾ | å…ˆé™æ€é“¾æ¥ï¼Œåæ”¹åŠ¨æ€ |
| æµ‹è¯•å‘ç°ä¸¥é‡é—®é¢˜ | ä¿ç•™ä¸€å¤© buffer ä¿®å¤ |

---

## ğŸ¯ ç¬¬ä¸‰å‘¨æˆåŠŸæ ‡å‡†ï¼ˆä¿®è®¢ç‰ˆï¼‰

### å¿…é¡»è¾¾æˆ (P0)
- [ ] libtmuxcore.so æˆåŠŸæ„å»ºå¹¶å¯åŠ è½½
- [ ] Ghostty æˆåŠŸé“¾æ¥ libtmuxcore
- [ ] åŸºæœ¬ tmux å‘½ä»¤å¯æ‰§è¡Œï¼ˆnew, splitï¼‰
- [ ] æ— å´©æºƒï¼Œæ— å†…å­˜æ³„æ¼

### åº”è¯¥è¾¾æˆ (P1)  
- [ ] æ€§èƒ½è¾¾åˆ° 60 FPS
- [ ] vim/neovim æ­£å¸¸å·¥ä½œ
- [ ] å¤åˆ¶æ¨¡å¼å¯ç”¨
- [ ] æ–‡æ¡£æ›´æ–°å®Œæˆ

### å¯ä»¥è¾¾æˆ (P2)
- [ ] HiDPI æ”¯æŒ
- [ ] ä¼šè¯æŒä¹…åŒ–
- [ ] CI/CD é›†æˆ
- [ ] åŒ…ç®¡ç†å™¨æ”¯æŒ

---

## ğŸ“… è¯¦ç»†æ—¶é—´çº¿

### Day 1 (å‘¨ä¸€)
- 09:00 - 12:00: T-301-R tmux æºç åˆ†æä¸è§„åˆ’
- 14:00 - 18:00: T-301-R å®æ–½ tty.c ä¿®æ”¹

### Day 2 (å‘¨äºŒ)  
- 09:00 - 12:00: T-301-R å®Œæˆ ui_backend ç»“æ„
- 14:00 - 18:00: T-302-R æ„å»º libtmuxcore.so

### Day 3 (å‘¨ä¸‰)
- 09:00 - 12:00: T-303-R Ghostty tmux æ¨¡å—åˆ›å»º
- 14:00 - 18:00: T-303-R å›è°ƒç³»ç»Ÿé›†æˆ

### Day 4 (å‘¨å››)
- 09:00 - 12:00: T-304-R Terminal æ¨¡å—é›†æˆ
- 14:00 - 18:00: T-304-R è°ƒè¯•ä¸åˆæ­¥æµ‹è¯•

### Day 5 (å‘¨äº”)
- 09:00 - 12:00: T-305-R é›†æˆæµ‹è¯•
- 14:00 - 16:00: Bug ä¿®å¤
- 16:00 - 18:00: Demo å‡†å¤‡ä¸æ–‡æ¡£

---

## ğŸš€ æ‰§è¡Œå»ºè®®

### ç»™é¡¹ç›®ç»ç†
1. **ä¼˜å…ˆçº§è°ƒæ•´**: å…ˆå®Œæˆ P0 ä»»åŠ¡ï¼Œç¡®ä¿åŸºæœ¬é›†æˆ
2. **é£é™©æ§åˆ¶**: æ¯ä¸ªä¿®æ”¹éƒ½è¦æœ‰ fallback æ–¹æ¡ˆ
3. **æŒç»­éªŒè¯**: æ¯å®Œæˆä¸€ä¸ªé›†æˆç‚¹ç«‹å³æµ‹è¯•
4. **æ–‡æ¡£åŒæ­¥**: ä¿®æ”¹ä»£ç åŒæ—¶æ›´æ–°æ–‡æ¡£

### ç»™å¼€å‘å›¢é˜Ÿ
1. **ä¿ç•™åŸå‹ä»£ç **: cache/week2 ä½œä¸ºå‚è€ƒï¼Œä¸è¦åˆ é™¤
2. **å°æ­¥å¿«è·‘**: æ¯ä¸ª commit éƒ½è¦å¯ç¼–è¯‘å¯è¿è¡Œ
3. **å……åˆ†æµ‹è¯•**: ä¿®æ”¹æºç å‰å…ˆå†™æµ‹è¯•
4. **åŠæ—¶æ²Ÿé€š**: é‡åˆ°é—®é¢˜ç«‹å³ä¸ŠæŠ¥

### ç»™æ¶æ„å¸ˆ
1. **å®¡æ ¸é›†æˆç‚¹**: é‡ç‚¹å®¡æŸ¥ tty.c å’Œ Terminal.zig ä¿®æ”¹
2. **æ€§èƒ½ç›‘æ§**: ç¡®ä¿é›†æˆä¸å½±å“æ€§èƒ½
3. **æ¥å£è®¾è®¡**: ç¡®ä¿ API å‘åå…¼å®¹
4. **å®‰å…¨å®¡è®¡**: æ£€æŸ¥å†…å­˜ç®¡ç†å’Œé”™è¯¯å¤„ç†

---

## ğŸ“ æ€»ç»“

ç¬¬ä¸‰å‘¨çš„æ ¸å¿ƒä»»åŠ¡æ˜¯å°†ç¬¬äºŒå‘¨çš„åŸå‹æˆæœçœŸæ­£é›†æˆåˆ° tmux å’Œ Ghostty æºç ä¸­ã€‚è¿™éœ€è¦ï¼š

1. **è°¨æ…ä¿®æ”¹æºç ** - ä½¿ç”¨æ¡ä»¶ç¼–è¯‘ä¿æŠ¤
2. **æ¸è¿›å¼é›†æˆ** - å…ˆæ ¸å¿ƒåŠŸèƒ½ï¼Œåé«˜çº§ç‰¹æ€§
3. **å……åˆ†æµ‹è¯•** - æ¯æ­¥éƒ½è¦éªŒè¯
4. **ä¿ç•™é€€è·¯** - éšæ—¶å¯å›æ»šåˆ°ä¼ ç»Ÿæ¨¡å¼

**å…³é”®æˆåŠŸå› ç´ **ï¼š
- æºç ä¿®æ”¹çš„ç²¾ç¡®æ€§
- æ„å»ºç³»ç»Ÿçš„æ­£ç¡®é…ç½®
- é›†æˆæµ‹è¯•çš„å…¨é¢æ€§
- å›¢é˜Ÿåä½œçš„ç´§å¯†æ€§

---

**æ–‡æ¡£çŠ¶æ€**: å¾…æ¶æ„å¸ˆè¯„å®¡  
**ä¸‹ä¸€æ­¥**: éƒ¨ç½²ç»™ system-architect (Window 1) è¿›è¡ŒæŠ€æœ¯è¯„å®¡