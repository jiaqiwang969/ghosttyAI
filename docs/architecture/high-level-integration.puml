@startuml high-level-integration
!theme plain
title Ghostty Ã— tmux High-Level Integration Architecture

skinparam componentStyle rectangle
skinparam packageStyle rectangle
skinparam defaultTextAlignment center

package "Ghostty Terminal" {
    component [Ghostty App] as GApp #LightBlue
    component [Terminal Buffer] as TBuf #LightBlue
    component [GPU Renderer] as GPU #LightBlue
    component [Input Handler] as Input #LightBlue
    component [Window Manager] as WinMgr #LightBlue
    
    package "Integration Layer" {
        component [FFI Bridge\n(Zig)] as FFI #LightGreen
        component [Event Loop\nAdapter] as LoopAdapter #LightGreen
        component [Grid Mapper] as GridMap #LightGreen
    }
}

package "libtmuxcore" {
    component [tmux Server] as Server #LightYellow
    component [Session/Window/Pane] as SWP #LightYellow
    component [Grid System] as Grid #LightYellow
    component [Screen Writer] as SWrite #LightYellow
    component [UI Backend] as UIBack #Orange
    component [Command System] as Cmd #LightYellow
    component [PTY/Process] as PTY #LightYellow
}

package "Callbacks" {
    interface "on_grid_update" as CB1
    interface "on_layout_change" as CB2
    interface "on_copy_mode" as CB3
    interface "on_title_change" as CB4
}

' Connections
GApp --> FFI : Initialize
FFI --> Server : tmc_server_new()
Input --> FFI : Key/Mouse Events
FFI --> Server : tmc_send_keys()

Server --> SWP : Manage
SWP --> Grid : Update
Grid --> SWrite : Write
SWrite --> UIBack : tty_write()
UIBack --> CB1 : Grid Updates
UIBack --> CB2 : Layout Changes
UIBack --> CB3 : Copy Mode
UIBack --> CB4 : Titles

CB1 --> GridMap : Process
CB2 --> GridMap : Process
CB3 --> GridMap : Process
CB4 --> GridMap : Process

GridMap --> TBuf : Update Cells
TBuf --> GPU : Render
GPU --> WinMgr : Display

PTY --> Server : Process I/O
Cmd --> Server : Execute

LoopAdapter --> Server : Event Loop

note right of UIBack
  **Key Innovation**
  Replaces TTY escape sequences
  with structured callbacks
end note

note bottom of FFI
  **C ABI Bridge**
  - Stable API version
  - Thread-safe callbacks
  - Memory management
end note

@enduml