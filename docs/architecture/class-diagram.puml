@startuml class-diagram
!theme plain
title Core Class/Structure Diagram

skinparam classAttributeIconSize 0
skinparam defaultTextAlignment center

package "libtmuxcore C API" {
    class tmc_server {
        - internal: void*
        + tmc_server_new()
        + tmc_server_free()
    }
    
    class tmc_client {
        - server: tmc_server*
        - session_id: uint32_t
        - rows: uint32_t
        - cols: uint32_t
        + tmc_client_attach()
        + tmc_client_detach()
        + tmc_client_resize()
    }
    
    class tmc_cell {
        + ch: uint32_t
        + fg_rgb: uint32_t
        + bg_rgb: uint32_t
        + attrs: uint16_t
        + width: uint8_t
    }
    
    class tmc_span {
        + pane_id: uint32_t
        + y: uint32_t
        + x_start: uint32_t
        + len: uint32_t
        + cells: tmc_cell*
    }
    
    class tmc_grid_update {
        + pane_id: uint32_t
        + rows: uint32_t
        + cols: uint32_t
        + span_count: uint32_t
        + spans: tmc_span*
        + full: int
    }
    
    class tmc_layout_node {
        + type: int
        + pane_id: uint32_t
        + x: uint32_t
        + y: uint32_t
        + w: uint32_t
        + h: uint32_t
    }
    
    class tmc_ui_vtable {
        + on_grid: callback
        + on_layout: callback
        + on_title: callback
        + on_copy_mode: callback
        + on_process_exit: callback
        + on_message: callback
    }
    
    class tmc_loop_vtable {
        + add_fd: callback
        + mod_fd: callback
        + del_fd: callback
        + add_timer: callback
        + del_timer: callback
        + post: callback
    }
}

package "tmux Internal Structures" {
    class tmux_server {
        + clients: list
        + sessions: list
        + windows: list
        + options: options
        + socket_path: string
    }
    
    class tmux_session {
        + name: string
        + windows: list
        + curw: winlink
        + options: options
        + environ: environ
    }
    
    class tmux_window {
        + name: string
        + panes: list
        + active: pane
        + layout_root: layout_cell
        + sx: u_int
        + sy: u_int
    }
    
    class tmux_pane {
        + id: u_int
        + screen: screen
        + pty: fd
        + pid: pid_t
        + sx: u_int
        + sy: u_int
    }
    
    class tmux_grid {
        + sx: u_int
        + sy: u_int
        + hsize: u_int
        + linedata: grid_line*
        + history: grid_line*
    }
    
    class ui_backend {
        + vtable: ui_backend_vtable*
        + user_data: void*
        + aggregate_buffer: buffer
        + flush_timer: timer
    }
}

package "Ghostty Structures (Zig)" {
    class GhosttyMux {
        + server: *TmcServer
        + client: *TmcClient
        + pane_map: HashMap
        + init()
        + deinit()
        + onGrid()
        + onLayout()
    }
    
    class Terminal {
        + rows: usize
        + cols: usize
        + buffer: CellBuffer
        + cursor: Cursor
        + updateRegion()
        + render()
    }
    
    class CellBuffer {
        + cells: [][]Cell
        + dirty_regions: []Region
        + updateCell()
        + markDirty()
    }
    
    class Cell {
        + char: u32
        + fg: Color
        + bg: Color
        + attrs: Attributes
    }
    
    class SplitTree {
        + root: Node
        + active: *Node
        + split()
        + resize()
        + remove()
    }
}

' Relationships
tmc_server "1" *-- "n" tmc_client
tmc_client "1" -- "1" tmux_session
tmc_grid_update "1" *-- "n" tmc_span
tmc_span "1" *-- "n" tmc_cell

tmux_server "1" *-- "n" tmux_session
tmux_session "1" *-- "n" tmux_window
tmux_window "1" *-- "n" tmux_pane
tmux_pane "1" *-- "1" tmux_grid

ui_backend "1" o-- "1" tmc_ui_vtable
tmc_server "1" o-- "1" tmc_loop_vtable

GhosttyMux "1" *-- "1" tmc_server
GhosttyMux "1" *-- "n" Terminal
Terminal "1" *-- "1" CellBuffer
CellBuffer "1" *-- "n" Cell

' Connections between layers
tmc_server ..> tmux_server : wraps
tmc_client ..> tmux_session : references
ui_backend ..> GhosttyMux : callbacks
tmux_grid ..> tmc_grid_update : converts to

note right of tmc_cell
  Stable C ABI structure
  for cell data exchange
end note

note bottom of GhosttyMux
  Main Zig integration point
  managing tmux instance
end note

@enduml